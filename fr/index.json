[{"content":"","date":"25 Janvier 2023","permalink":"/fr/authors/","section":"Authors","summary":"","title":"Authors"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/c/","section":"Tags","summary":"","title":"C"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/categories/","section":"Categories","summary":"","title":"Categories"},{"content":" Architecte IT, d√©veloppeur senior, consultant \u0026amp; formateur Je suis un architecte IT, un d√©veloppeur passionn√©, un consultant pragmatique et un formateur enthousiaste. Que vous ayez besoin de produire quelque chose de neuf, d\u0026rsquo;examiner votre architecture logicielle, ou de former votre √©quipe sur les derni√®res technologies, je suis l√† pour vous aider.\nJ\u0026rsquo;aime r√©soudre des probl√®mes. J\u0026rsquo;apporte une approche honn√™te et r√©aliste √† mon travail, en m\u0026rsquo;assurant toujours que je fournis des solutions qui r√©pondent √† vos besoins sp√©cifiques en tenant compte de vos contraintes. Je suis transparent sur ce qu\u0026rsquo;il est possible ou non de faire et sous quelles conditions, mon but n\u0026rsquo;est pas de vendre du r√™ve mais de tenir des promesses: la plupart de mes livraisons sont faites sans surprises et dans les d√©lais.\nMon taux journalier moyen varie en fonction du projet et du niveau d\u0026rsquo;expertise attendu, se situant entre 750 et 1250 euros, selon les comp√©tences auxquelles il fait appel.\nN\u0026rsquo;h√©sitez pas √† analyser mon travail sur Github ou √† regarder mon profil LinkedIn, les recommandations qui m\u0026rsquo;ont √©t√© laiss√©es, mais aussi √† contacter des personnes ayant travaill√©es avec moi pour leur demander leur avis.\nSi vous pensez que nous pourrions faire une bonne √©quipe, n\u0026rsquo;h√©sitez pas √† me contacter !\nAu plaisir de collaborer avec vous bient√¥t.\n","date":"25 Janvier 2023","permalink":"/fr/authors/gilles/","section":"Authors","summary":"Architecte IT, d√©veloppeur senior, consultant \u0026amp; formateur Je suis un architecte IT, un d√©veloppeur passionn√©, un consultant pragmatique et un formateur enthousiaste. Que vous ayez besoin de produire quelque chose de neuf, d\u0026rsquo;examiner votre architecture logicielle, ou de former votre √©quipe sur les derni√®res technologies, je suis l√† pour vous aider.","title":"Gilles Chehade"},{"content":" TL;DR: J\u0026rsquo;ai retrouv√© une copie imprim√©e d\u0026rsquo;un devoir que j\u0026rsquo;ai eu √† faire en 2005, quand j\u0026rsquo;√©tais encore √©tudiant, pour impl√©menter un appel syst√®me sous OpenBSD et Linux. J\u0026rsquo;ai perdu le fichier source LaTeX alors j\u0026rsquo;ai d√©cid√© de le retaper pour en avoir une copie num√©rique. √Ä l\u0026rsquo;origine, l\u0026rsquo;article couvrait les \u0026ldquo;loadable kernel modules\u0026rdquo; (LKM) qui ne font plus partie d\u0026rsquo;OpenBSD, j\u0026rsquo;ai donc supprim√© cette partie. J\u0026rsquo;ai aussi supprim√© la partie Linux parce qu\u0026rsquo;elle ne m\u0026rsquo;int√©ressait pas √† l\u0026rsquo;√©poque, que j\u0026rsquo;ai √©crit le minimum vital pour mon devoir et que ce n\u0026rsquo;est donc pas tr√®s int√©ressant √† lire ;-) Avertissement # Le contenu de cet article est bas√© sur un devoir que j\u0026rsquo;ai r√©dig√© en 2005, lorsque j\u0026rsquo;√©tais encore √©tudiant √† Epitech, donc les choses ont probablement chang√© et ce n\u0026rsquo;est pas un tutoriel: s\u0026rsquo;il vous plait, n\u0026rsquo;√©crivez pas d\u0026rsquo;appels syst√®mes et ne les soumettez pas √† OpenBSD\u0026hellip; sauf si les d√©veloppeurs d\u0026rsquo;OpenBSD vous ont demand√© de le faire et vous ont dit que c\u0026rsquo;√©tait une bonne id√©e.\nJE LE R√âP√àTE: N\u0026rsquo;\u0026hellip; IMPL√âMENTEZ\u0026hellip; PAS\u0026hellip; D\u0026rsquo;\u0026hellip; APPELS\u0026hellip; SYST√àMES\u0026hellip; √Ä\u0026hellip; PARTIR\u0026hellip; DE\u0026hellip; CET\u0026hellip; ARTICLE !\nL\u0026rsquo;article a pour objectif de partager de la connaissance, et d\u0026rsquo;√©viter de perdre quelque chose que j\u0026rsquo;ai √©crit et qui n\u0026rsquo;existe plus qu\u0026rsquo;en version papier. Voyez le comme un vestige arch√©ologique.\nJ\u0026rsquo;ai accidentellement leak√© une version brouillon de cet article il y a trois ans, devenue tr√®s rapidement populaire suite √† un partage sur un site connu\u0026hellip; avant que je ne la supprime parce que je n\u0026rsquo;avais pas fini de le nettoyer et de mettre cet avertissement. Cette fois ci, j\u0026rsquo;ai √©t√© plus malin, j\u0026rsquo;ai tout r√©dig√© avant de faire mon commit.\nJ\u0026rsquo;ai fait quelques changements mineurs pour aider √† la compr√©hension, mais je n\u0026rsquo;ai pas modifi√© le style d\u0026rsquo;√©criture, vous lisez le moi d\u0026rsquo;il y a 18 ans qui faisait un devoir scolaire.\nLes exemples sont tr√®s simples, ils ne sont pas l√† pour servir de fondation √† vos projets, mais juste pour aider certains √† faire leurs premiers pas sur les marches de la compr√©hension. Trouvez les erreurs est un petit cadeau que je vous laisse: je vous encourage √† commenter ou soumettre des pull requests pour am√©liorer cet article.\nQuelques rappels n√©cessaires # Programme et Processus # Les gens utilisent souvent les deux mots de mani√®re interchangeable mais il est important de comprendre la diff√©rence entre un programme et un processus, particuli√®rement parce que le m√™me programme peut √™tre autoris√© √† utiliser un appel syst√®me dans un processus mais pas dans un autre (utilisateur privil√©gi√© ou non), mais aussi parce que la notion de processus fait partie de l\u0026rsquo;API des appels syt√®me (l\u0026rsquo;interface des appels syst√®me prends un pointeur sur une struct proc qui repr√©sente un processus).\nUn programme est un ex√©cutable qui contient un jeu d\u0026rsquo;instructions qui sont suppos√©es √™tre ex√©cut√©es et faire quelque chose. Il r√©side dans un fichier structur√© (a.out, elf, \u0026hellip;) dans le syst√®me de fichier qui impose des restrictions sur qui peut ou non l\u0026rsquo;ex√©cuter (permissions et ownership dans un syst√®me de fichiers). Un processus est une instance de ce programme, qui tourne dans un espace m√©moire qui lui est propre, avec ses propres privil√®ges.\nSi l\u0026rsquo;on prends /bin/ls, c\u0026rsquo;est un programme qui liste les r√©pertoires et fichiers. Lorsqu\u0026rsquo;un utilisateur l\u0026rsquo;ex√©cute, un processus est cr√©√© qui va effectivement ex√©cuter ce programme avec les privil√®ges de l\u0026rsquo;utilisateur, dans un espace m√©moire qui n\u0026rsquo;est pas partag√© avec les autres processus.\nKernel et userland # Les syst√®mes Unix-like ont une architecture o√π le code est ex√©cut√© dans deux zones principales: le kernel (noyau) et le userland (espace utilisateur).\nLe kernel est en charge de fournir et limiter l\u0026rsquo;acc√®s aux mat√©riels, imposer des restrictions sur ce qu\u0026rsquo;un programme peut faire, et fournir un espace m√©moire virtuel aux programmes dans lesquels ils peuvent s\u0026rsquo;ex√©cut√©r.\nUn programme s\u0026rsquo;ex√©cute en userland et effectue des op√©rations sur une m√©moire qui lui est allou√©e par le kernel durant l\u0026rsquo;initialisation du processus. Lorsque le programme doit acc√©der √† un mat√©riel ou a besoin que le kernel fasse une op√©ration qu\u0026rsquo;il n\u0026rsquo;est pas autoris√© √† faire lui m√™me, il demande au kernel de d√©clencher un appel syst√®me. L\u0026rsquo;appel syst√®me est une fonction qui fait partie du kernel et qui s\u0026rsquo;ex√©cute en lui de la part du processus.\nAppel syst√®me # Un appel syst√®me est un service fourni par le kernel pour qu\u0026rsquo;un processus userland puisse demander au kernel de faire quelque chose √† sa place, g√©n√©ralement quelque chose que le programme useland n\u0026rsquo;est pas capable ou pas autoris√© √† faire lui m√™me.\nDu point de vue d\u0026rsquo;un programme, c\u0026rsquo;est une fonction un peu particuli√®re qu\u0026rsquo;il peut appeler comme n\u0026rsquo;importe quelle autre fonction, mais qui ne s\u0026rsquo;ex√©cute pas dans l\u0026rsquo;espace m√©moire du processus. Un programme connait seulement l\u0026rsquo;interface des appels syst√®mes mais n\u0026rsquo;a pas acc√®s √† leur impl√©mentation, il peut donc les appeler, leur passer des param√®tres, obtenir un r√©sultat, mais ne peut pas inspecter ce qu\u0026rsquo;il se passe √† l\u0026rsquo;int√©rieur de l\u0026rsquo;appel syst√®me pendant qu\u0026rsquo;il s\u0026rsquo;ex√©cute. Il ne peut pas le debugger.\n√áa vient avec des effets de bord. C√¥t√© performances, un appel syst√®me bascule de l\u0026rsquo;ex√©cution en userland √† une ex√©cution en kernel qui est plus co√ªteuse. Ensuite, des bugs dans un appel syst√®me ont un impact bien diff√©rents des bugs dans une fonction: une corruption m√©moire peut provoquer le crash d\u0026rsquo;un processus, la m√™me corruption m√©moire dans un appel syst√®me peut provoquer le crash du syst√®me.\nIl y a deux aspects aux appels syst√®mes:\nL\u0026rsquo;impl√©mentation de l\u0026rsquo;appel syst√®ne, le code effectif de l\u0026rsquo;appel syst√®me qui sera ex√©cut√© dans le kernel lorsqu\u0026rsquo;il sera appell√©, et l\u0026rsquo;interface de l\u0026rsquo;appel syst√®me, la mani√®re dont l\u0026rsquo;appel syst√®me est suppos√© √™tre appel√© depuis une application en userland.\nC\u0026rsquo;est important de diff√©rencier les deux comme, dans OpenBSD, le prototype pour l\u0026rsquo;impl√©mentation d\u0026rsquo;un appel syst√®me ne corresponds pas au prototype de l\u0026rsquo;interface pour le m√™me appel syst√®me comme nous allons voir.\n@gpt-4: Les appels syst√®me servent de passerelle entre les applications utilisateur et le noyau du syst√®me d\u0026rsquo;exploitation de bas niveau. Ils sont une partie int√©grale de l\u0026rsquo;infrastructure d\u0026rsquo;un syst√®me d\u0026rsquo;exploitation qui fournit un acc√®s contr√¥l√© aux ressources mat√©rielles, g√®re les processus et g√®re les interactions avec le syst√®me de fichiers, parmi de nombreuses autres t√¢ches.\nAlors que les syst√®mes d\u0026rsquo;exploitation sont livr√©s avec un ensemble standard d\u0026rsquo;appels syst√®me, il peut y avoir des cas o√π vous souhaitez introduire des appels syst√®me personnalis√©s. Ceux-ci pourraient √™tre destin√©s √† du mat√©riel sp√©cialis√©, √† des exigences de gestion de processus uniques, ou √† d\u0026rsquo;autres personnalisations au niveau de l\u0026rsquo;OS qui ne sont pas fournies par les appels syst√®me int√©gr√©s.\nComprendre comment ajouter de nouveaux appels syst√®me dans un syst√®me comme OpenBSD, ouvre donc une porte vers des innovations et des personnalisations au niveau du syst√®me.\nImpl√©menter des appels syst√®me pour OpenBSD # Pr√©-requis # Utiliser un compte privil√©gi√© # Il est √©vident qu\u0026rsquo;un compte non privil√©gi√© n\u0026rsquo;est pas autoris√© √† modifier le kernel comme il v√©rifie les permissions sur le syst√®me. Pour cette raison, il faut n√©cessairement avoir un compte privil√©gi√© au moins pour installer le kernel modifi√©.\nAvoir les sources du syst√®me # Les sources du syst√®me sont disponibles directemnet depuis le projet OpenBSD. Pour ce devoir, nous aurons besoin des archives suivantes:\nsrc.tar.gz srcsys.tar.gz Il faudra les extraire √† la racine du syst√®me:\n% doas tar -C / -zxf src.tar.gz % doas tar -C / -zxf srcsys.tar.gz (edit: doas remplace maintenant sudo)\nSavoir comment rebuilder un kernel # Une fois que vous avez acc√®s aux sources du syst√®me, vous pouvez rebuilder un kernel en utilisant les commandes suivantes:\n# cd /usr/src/sys/arch/amd64/config # config GENERIC # cd ../compile/GENERIC # make clean depend install Le rebuild ne prends que quelques minutes et une copie de sauvegarde du pr√©cedent kernel est faite automatiquement au cas o√π le nouveau kernel serait instable.\nRebuilder le syst√®me # Rebuilder le syst√®me peut √™tre n√©cessaire si les changements du kernel affectent des outils userland.. Ce peut √™tre le cas par exemple si vous modifiez la struct proc qui est utilis√©e par des outils comme ps, top ou uname. Rebuilder est aussi simple que de taper:\n# cd /usr/src # make build Rebuilder le syst√®me est consid√©rablement plus long que pour le kernel et peut prendre de quelques minutes √† plusieurs heures selon l\u0026rsquo;architecture.\nAppel syst√®me sans param√®tres: sys_goodbye() # Pour d√©buter, nous allons impl√©menter l\u0026rsquo;appel syst√®me sys_goodbye() qui ne prends aucun param√®tre. Son prototype est:\nint goodbye(void); Impl√©mentation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* displays \u0026#34;Goodbye, cruel world !\u0026#34; on the console */ sys_goodbye(struct proc *p, void *v, register_t *retval) { printf(\u0026#34;Goodbye, cruel world !\\n\u0026#34;); return (0); } Description # Notre premier appel syst√®me affiche la phrase \u0026ldquo;Goodbye, cruel world !\u0026rdquo; sur la console.\nIl nous permet de voir que le prototype de l\u0026rsquo;appel syst√®me diff√®re entre le userland et le kernel. OpenBSD fournit une API unique pour tous les appels syst√®mes, peu importe le prototype qu\u0026rsquo;ils exposent au userland.\nLes headers inclus ici sont le set minimal requis pour que l\u0026rsquo;API des appels syst√®me fonctionne normalement. Certains peuvent paraitre inutilis√©s par notre fonction mais seront utilis√© lors du build pour la plomberie interne du kernel. L\u0026rsquo;appel syst√®me ne se limite pas seulement √† son impl√©mentation, certains √©l√©ments seront ajout√©s par la suite indirectement et automatiquement comme on le verra.\nNe premier appel syst√®me va ignorer ses param√®tres (struct proc *, void *v et register_t *retval), utiliser printf() et retourner 0 pour indiquer √† l\u0026rsquo;appelant que l\u0026rsquo;ex√©cution s\u0026rsquo;est bien d√©roul√©e.\nIci, printf() ne doit pas √™tre confondu avec le printf() userland, le premier est utilis√© pour √©crire sur la console et non pas sur la sortie standard.\nAppel syst√®me avec param√®tres: sys_showparams() # Notre second appel syst√®me, sys_showparams(), prends un int en param√®tre et affiche sa valeur sur la console. Son prototype est le suivant:\nint showparams(int val); Implementation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* displays value of integer parameter to console */ sys_showparams(struct proc *p, void *v, register_t *retval) { struct sys_showparams_args /* { syscallarg(int)\tval; } */ *uap = v; printf(\u0026#34;showparams(%d)\\n\u0026#34;, SCARG(uap, val)); return (0); } Description # Contrairement √† la pr√©c√©dente, cette fonction n\u0026rsquo;ignore pas ses param√®tres mais en extraie un param√®tre entier pass√© dans l\u0026rsquo;interface userland.\nPour le faire, l\u0026rsquo;appel syst√®me d√©clare un pointeur vers une struct sys_showparams_args et le fait pointer sur son deuxi√®me param√®tre, void *v. Il devient clair que ce second param√®tre repr√©sente d\u0026rsquo;une certaine mani√®re les param√®tres que le userland passe √† l\u0026rsquo;appel syst√®me.\nLa d√©finition de struct sys_showparams_args ne fait pas partie de notre impl√©mentation parce qu\u0026rsquo;elle est g√©n√©r√©e automatiquement au moment du build. Chacun de ses champs correspond √† un param√®tre dans l\u0026rsquo;interface userland et la macro SCARG() permet de d√©r√©f√©rencer la structure correctement, sans avoir √† s\u0026rsquo;inqui√©ter de l\u0026rsquo;alignement ou de l\u0026rsquo;endian de l\u0026rsquo;architecture.\nAppel syst√®me retournant une valeur: sys_retparam() # L\u0026rsquo;appel syst√®me sys_retparam() prends un param√®tre de type int et le retourne s\u0026rsquo;il est inf√©rieur ou √©gal √† 1024, et dans le cas contraire retourne -1, en assignant EINVAL √† errno. Son prototype est similaire √† celui de sys_showparams():\nint retparam(int val); Implementation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* returns value of integer parameter if lesser or equal to 1024 */ sys_retparam(struct proc *p, void *v, register_t *retval) { struct sys_retparam_args /* { syscallarg(int)\tval; } */ *uap = v; unsigned int val; val = SCARG(uap, val); if (val \u0026gt; 1024) return (EINVAL); *retval = val; return (0); } Description # les choses sont un petit peu plus compl√®xes et nous allons devoir plonger sur ce qu\u0026rsquo;il se passe en dehors de la fonction pour comprendre son fonctionnement.\nLe probl√®me est le suivant: si nous devons retourner 0 en cas de succ√®s et une valeur positive en cas d\u0026rsquo;erreur, alors comment faire pour avoir un appel syst√®me qui retourne une valeur positive en cas de succ√®s ?\nLa solution r√©side dans le troisi√®me param√®tre de notre appel syst√®me.\nLa valeur retourn√©e par notre appel syst√®me n\u0026rsquo;est pas la valeur retourn√©e par l\u0026rsquo;interface de l\u0026rsquo;appel syst√®me pour le userland. La valeur de retour de notre appel syst√®me sert simplement √† d√©terminer si sont ex√©cution s\u0026rsquo;est d√©roul√©e correctement ou assigner errno. La valeur retourn√©e par l\u0026rsquo;interface userland est en r√©alit√© plac√©e dans le troisi√®me param√®tre de notre impl√©mentation d\u0026rsquo;appel syst√®me qui est en r√©lait√© un tableau de deux registres.\nLe premier √©l√©ment de ce tableau repr√©sente EAX, il est initialis√© √† 0 par l\u0026rsquo;API des appels syst√®mes avant que notre impl√©mentation ne soit appell√©e et ne puisse le modifier. Le second √©l√©ment est rarement utilis√©: il sert √† resoudre le cas particulier de fork() qui.. retourne deux valeurs, une pour le processus parent et une pour le processus enfant.\n@gilles: L\u0026rsquo;article a √©t√© √©crit pour amd64 o√π les registres EAX et EDX sont utilis√©s pour retval, ce n\u0026rsquo;est √©videmment pas le cas pour toutes les autres architectures.\nPour une meilleur compr√©hension, un coup d\u0026rsquo;oeil a /usr/src/sys/amd64/amd64/trap.c (en rempla√ßant la plateforme par une autre) est utile: il pr√©pare les param√®tres en respectant la convention d\u0026rsquo;appel, d√©clenche l\u0026rsquo;interruption d\u0026rsquo;appel syst√®me, fait correspondre les valeurs de registres et d\u0026rsquo;errno aux bonnes structures pour au final donner une impression uniforme au userland sur toutes les architectures.\nSystem call poking into struct proc: sys_retpid() # Notre dernier appel syst√®me, sys_retpid(), prends un int en param√®tre qui va faire retourner √† notre fonction le pid du processus si la valeur est 0, le pid du processus parent si la valeur est 1 et √©chouer en assignant EINVAL a errno dans les autres cas. Son prototype est le suivant:\nint retpid(int val); Impl√©mentation # #include \u0026lt;sys/types.h\u0026gt; #include \u0026lt;sys/param.h\u0026gt; #include \u0026lt;sys/systm.h\u0026gt; #include \u0026lt;sys/kernel.h\u0026gt; #include \u0026lt;sys/proc.h\u0026gt; #include \u0026lt;sys/mount.h\u0026gt; #include \u0026lt;sys/syscallargs.h\u0026gt; /* * returns current pid if val == 0 * returns parent pid if val == 1 * return -1 and sets errno to EINVAL otherwise */ sys_retpid(struct proc *p, void *v, register_t *retval) { struct sys_retpid_args /* { syscallarg(int)\tval; } */ *uap = v; unsigned int val; val = SCARG(uap, val); if (val != 0 \u0026amp;\u0026amp; val != 1) return (EINVAL); if (val == 0) *retval = p-\u0026gt;p_pid; else *retval = p-\u0026gt;p_pptr-\u0026gt;p_pid; return (0); } @gilles: Notez que cette fonction peu ou non exploser, pour de multiples raisons, et si vous ne comprenez pas pourquoi, ne copiez-collez pas ce code optimiste qui ne fait pas les v√©rifications et le locking ad√©quats.\nCe commentaire est valide pour toutes les fonctions de cet article.\nDescription # Ce dernier appel nous permet d\u0026rsquo;illustrer que la fonction ne s\u0026rsquo;ex√©cute pas en userland mais vraiment dans le kernel, il nous permets d\u0026rsquo;acc√©der √† la m√©moire en dehors de celle du processus courant. Ici, nous d√©r√©f√©ren√ßons la struct proc associ√©e √† notre processus mais aussi un pointeur vers une autre struct proc, nous pouvons utiliser les diff√©rentes listes chain√©es internes √† la struct proc pour acc√©der √† des ressources qui ne sont pas accessibles √† notre processus courant en userland.\nNotez que c\u0026rsquo;est juste un exemple et qu\u0026rsquo;il faut faire bien attention √† faire le bon locking requis, si l\u0026rsquo;appel syst√®me acc√®de √† une ressource qui a √©t√© lib√©r√©e, le r√©sultat ne sera pas un crash du processus mais un crash du syst√®me.\nInt√©gration # @gilles: La version initiale de cette article date de 2005 et pr√©sentait le link static et les loadable kernel modules. Depuis, l\u0026rsquo;interface LKM a √©t√© supprim√©e d\u0026rsquo;OpenBSD, j\u0026rsquo;ai donc supprim√© les parties qui ne pr√©sentaient plus d\u0026rsquo;int√©r√™t de nos jours pour garder l\u0026rsquo;article court. @gpt-4: Lors de la mise en ≈ìuvre de nouveaux appels syst√®me, il est essentiel de faire de la s√©curit√© une priorit√© dans vos consid√©rations. Par conception, les appels syst√®me font le pont entre l\u0026rsquo;espace utilisateur et le noyau, ce qui, s\u0026rsquo;il n\u0026rsquo;est pas correctement g√©r√©, peut exposer le syst√®me √† diverses vuln√©rabilit√©s.\nLors de la conception d\u0026rsquo;un appel syst√®me, il est crucial de valider toutes les donn√©es en entr√©e. Comme les appels syst√®me fonctionnent avec des privil√®ges de niveau noyau, toutes les donn√©es en entr√©e peuvent potentiellement interagir avec des parties critiques du syst√®me, et doivent donc √™tre soigneusement examin√©es.\nR√©fl√©chissez attentivement aux capacit√©s que votre nouvel appel syst√®me devrait avoir. Si un appel syst√®me a seulement besoin de lire des donn√©es, il ne devrait pas avoir la capacit√© d\u0026rsquo;√©crire des donn√©es. Limiter la fonctionnalit√© au minimum n√©cessaire peut limiter les dommages potentiels si l\u0026rsquo;appel syst√®me est mal utilis√©.\nDe plus, les probl√®mes de concurrence peuvent conduire √† des conditions de course dans les appels syst√®me. Des primitives de synchronisation appropri√©es doivent √™tre utilis√©es pour √©viter ces sc√©narios. N\u0026rsquo;oubliez pas, une faille dans un appel syst√®me peut mettre en p√©ril la s√©curit√© de l\u0026rsquo;ensemble du syst√®me, donc √™tre attentif aux vuln√©rabilit√©s potentielles est de la plus haute importance.\nGardez √† l\u0026rsquo;esprit qu\u0026rsquo;OpenBSD, comme d\u0026rsquo;autres syst√®mes de type Unix, suit le principe du privil√®ge minimal, qui sugg√®re qu\u0026rsquo;un processus ne devrait se voir accorder que les privil√®ges qui sont essentiels √† sa fonction. En tant que concepteur d\u0026rsquo;appel syst√®me, votre responsabilit√© est de vous assurer que votre appel syst√®me est en accord avec ce principe.\nInt√©gration d\u0026rsquo;appels syst√®me par linkage statique # Plusieurs fichiers sont en jeu lors d\u0026rsquo;une int√©gration statique d\u0026rsquo;appel syst√®me:\n/usr/src/sys/kern.syscalls.master est le fichier principal utilis√© pour ajouter un appel syst√®me. Il est utilis√© pour rebuilder un ensemble de tableaux et de structures internes utilis√©es par l\u0026rsquo;API des appels syst√®mes. /usr/src/sys/kern/syscalls.c contient la liste des appels syst√®me. /usr/src/sys/kern/init_sysent.c contient la table sysent. Chaque √©l√©ment de la table d√©crit le nombre de param√®tres de l\u0026rsquo;appel syst√®me, la structure qui est associ√©e √† ces param√®tres et la fonction utilis√©e pour impl√©menter l\u0026rsquo;appel syst√®me. /usr/src/sys/sys/syscallargs.h contient la d√©finition des structures associ√©es aux appels syst√®me. /usr/src/sys/sys/syscall.h contient les num√©ros associ√©s √† nos appels syst√®mes repr√©sent√©s par des macros. La premi√®re √©tape est d\u0026rsquo;√©diter /usr/src/sys/kern.syscalls.master et de trouver un num√©ro inutilis√© d\u0026rsquo;appel syst√®me, ou d\u0026rsquo;en ajouter un s\u0026rsquo;il n\u0026rsquo;y en a pas de disponible. Le format du fichier est tr√®s simple, il consiste en un num√©ro d\u0026rsquo;appel syst√®me, un type d\u0026rsquo;appel syst√®me et un pseudo-prototype.\nUne fois modifi√©, les fichiers autog√©n√©r√©s peuvent √™tre reconstruits par ces commandes:\n# cd /usr/src/sys/kern # make init_sysent.c Les fichiers d√©crits ci-dessus sont reconstruits en prenant en compte les nouveaux appels syst√®mes et en produisant les structures n√©cessaires pour leurs param√®tres. Tout ce qu\u0026rsquo;il reste √† faire est de reconstruire le kernel apr√®s avoir ajout√© les fichiers contenant les impl√©mentations de nos appels syst√®me.\nLes appels syst√®me sont ind√©pendant de l\u0026rsquo;architecture, leurs impl√©mentations sont plac√©ees dans /usr/src/sys/kern.\nVous devez ensuite √©diter /usr/src/sys/kern/files et y ajouter les lignes suivantes:\nfile kern/sys_goodbye.c file kern/sys_showparam.c file kern/sys_retparam.c file kern/sys_retpid.c puis reconstruire le kernel.\n√Ä ce stade, une fois le syst√®me red√©marr√© sur le nouveau kernel, nos appels syst√®mes sont utilisables par les applications en userland qui connaissent leur num√©ro au travers de l\u0026rsquo;appel syst√®me syscall().\nPour pouvoir les appeler par leur nom, vous devrez mettre √† jour les fichiers d\u0026rsquo;ent√™tes /usr/include/sys/syscall.h et /usr/include/sys/sycallargs.h avec ceux g√©n√©r√©s durant la phase de make init_sysent.c, puis reconstruire la libc apr√®s avoir ajout√© les fichiers objets (sans leur pr√©fixe sys_) dans /usr/src/lib/libc/sys/Makefile.inc.\nLa libc est reconstruire avec les commandes suivantes:\n# cd /usr/src/lib/libc # make install Les appels syst√®mes sont imm√©diatement disponibles sans besoin d\u0026rsquo;un red√©marrage du syst√®me.\nUn mot du futur, 2023 # Soyez gentils avec le gilles@ de 2005, n\u0026rsquo;h√©sitez pas √† commenter ou soumettre une pull request pour mettre √† jour l\u0026rsquo;article et le moderniser.\nAu cas o√π vous vous le demandez, cette interface n\u0026rsquo;est pas exactement celle de NetBSD ou de FreeBSD, mais les interfaces et structures se ressemblent assez pour pouvoir d√©marrer. Si vous le voulez, je pourrais √©crire quelques articles autour de ces sujets √† l\u0026rsquo;avenir.\nAu cas o√π vous vous le demandez aussi, cette interface ne vous aidera pas du tout pour √©crire un appel syst√®me sous Linux. Tout diff√®re, depuis la mani√®re dont le code est organis√©, √† la mani√®re dont les appels syst√®mes sont enregistr√©s, en passant par la convention d\u0026rsquo;appel. Les concepts sont les m√™mes, l\u0026rsquo;impl√©mentation et les API sont radicalement diff√©rentes. J\u0026rsquo;ai √©crit un devoir l√† dessus aussi, impl√©mentant exactement les m√™mes appels syst√®mes en d√©crivant le cheminement, mais j\u0026rsquo;ai trouv√© √ßa p√©nible au possible et √ßa se ressentait dans l\u0026rsquo;article üòÜ\nLectures en rapport\u0026hellip; # Je recommande la lecture de ces deux livres sur le sujet:\n","date":"25 Janvier 2023","permalink":"/fr/posts/2023-07-25/implementer-un-appel-syst%C3%A8me-pour-openbsd/","section":"Posts","summary":"TL;DR: J\u0026rsquo;ai retrouv√© une copie imprim√©e d\u0026rsquo;un devoir que j\u0026rsquo;ai eu √† faire en 2005, quand j\u0026rsquo;√©tais encore √©tudiant, pour impl√©menter un appel syst√®me sous OpenBSD et Linux.","title":"Implementer un appel syst√®me pour OpenBSD"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/kernel/","section":"Tags","summary":"","title":"kernel"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/openbsd/","section":"Tags","summary":"","title":"OpenBSD"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/","section":"poolp.org","summary":"","title":"poolp.org"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/posts/","section":"Posts","summary":"","title":"Posts"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/tags/","section":"Tags","summary":"","title":"Tags"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/categories/technologie/","section":"Categories","summary":"","title":"technologie"},{"content":"","date":"25 Janvier 2023","permalink":"/fr/categories/musique/","section":"Categories","summary":"","title":"musique"},{"content":" TL;DR: Je vais parler de musique sur ce site √† partir de maintenant. Ce blog est un blog musical aussi # Comme certains le savent, j\u0026rsquo;ai un profond int√©r√™t pour la musique.\nCette section du blog va se concentrer sur des sujets li√©s √† la musique, aussi bien du point de vue d\u0026rsquo;un auditeur, que de celle d\u0026rsquo;un musicien amateur et/ou d\u0026rsquo;un producteur.\nJe posterai des fois des liens vers de la musique que j\u0026rsquo;ai envie de partager, parce que je l\u0026rsquo;ai moi-m√™me produite, ou parce que je l\u0026rsquo;ai aim√©e, mais j\u0026rsquo;√©crirais aussi des articles et partagerai des reviews de mat√©riels et logiciels.\n","date":"25 Janvier 2023","permalink":"/fr/posts/2023-06-25/une-nouvelle-section-apparait/","section":"Posts","summary":"TL;DR: Je vais parler de musique sur ce site √† partir de maintenant. Ce blog est un blog musical aussi # Comme certains le savent, j\u0026rsquo;ai un profond int√©r√™t pour la musique.","title":"Une nouvelle section apparait !"},{"content":" TL;DR: - le greylisting est une bonne id√©e - ce n'est pas tr√®s pratique aujourd'hui - beaucoup de gens se passent du greylisting ou trouvent des contournements - le SPF-aware greylisting rend le greylisting utilisable √† nouveau Shout out a mes sponsors ‚ù§Ô∏è # Un GRAND MERCI √† mes sponsors sur github et patreon: votre soutien est grandement appr√©ci√© !\nO√π est-ce que j\u0026rsquo;ai d√©j√† lu √ßa ? # Cet article est une traduction de l\u0026rsquo;article \u0026ldquo; SPF-aware greylisting and filter-greylist\u0026rdquo;, publi√© sur ce blog d√©but D√©cembre.\nC\u0026rsquo;est mon troisi√®me article r√©dig√© en fran√ßais depuis des ann√©es, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nN\u0026rsquo;h√©sitez pas √† partager la publication √† l\u0026rsquo;aide des ic√¥nes en fin d\u0026rsquo;article et √† la commenter \u0026lt;3\nBonne lecture !\nLes erreurs SMTP en quelques mots # SMTP est un protocole fail-safe qui essaie de son mieux de garantir que les messages ne se perdent pas en transit. Parmi les diff√©rents m√©canismes et exigences du standard on trouve l\u0026rsquo;utilisation d\u0026rsquo;√©checs temporaires.\nConcr√®tement, un n≈ìud SMTP a deux √©tats finaux pour un message : soit le message est distribu√© et le n≈ìud destination le d√©tient, soit il n\u0026rsquo;est PAS distribu√© et le n≈ìud destination ne le d√©tient pas. Dans le second cas, le protocole SMTP exige que le dernier n≈ìud en charge notifie l\u0026rsquo;√©metteur qu\u0026rsquo;une erreur est survenue. Soit en rejetant le message lors de la session, soit √† l\u0026rsquo;aide d\u0026rsquo;une mail d\u0026rsquo;erreur diff√©r√© (aussi connu sous le nom de MAILER-DAEMON).\nEnfin, il y a un troisi√®me √©tat qui n\u0026rsquo;est pas final : l\u0026rsquo;√©chec temporaire. Il couvre tous les cas d\u0026rsquo;erreurs qui ont pu temporairement emp√™cher la distribution‚Ä¶ mais qui pourraient tout aussi bien ne plus se produire si quelque chose √©tait corrig√© sur le n≈ìud de destination.\nContrairement aux mails distribu√©s, que les destinataires voient, et aux mails √©chou√©s, que les √©metteurs voient, les mails en √©chec temporaire ne sont g√©n√©ralement pas vus par les utilisateurs. Ils sont trait√©s entre les Mail eXchangers (MX) qui tentent de se les retransmettre en arri√®re-plan. Il ne sont g√©n√©ralement vus par les utilisateurs que lorsque les tentatives finissent par r√©ussir ou qu\u0026rsquo;elles √©chouent d√©finitivement apr√®s que leur temps de vie a expir√©.\nDans le premier cas, le destinataire va recevoir le message un peu plus tard que pr√©vu, le plus souvent sans m√™me avoir su que des tentatives de retransmission ont eu lieu. Dans le second cas, l\u0026rsquo;√©metteur recevra une notification lui indiquant que, malgr√© les retransmissions, le message n\u0026rsquo;a pas pu √™tre distribu√© dans le d√©lai imparti.\nLes strat√©gies de retransmission en cas d\u0026rsquo;√©chec temporaire sont g√©r√©es diff√©remment dans les diff√©rents logiciels, mais vous pouvez postuler qu\u0026rsquo;il y aura une retransmission dans les secondes ou minutes qui suivent un √©chec temporaire. Une approche populaire, l\u0026rsquo;incr√©ment quadratique du d√©lai, cr√©e un d√©lai initialement court mais qui augmente avec le nombre de tentatives en √©chec de sorte que plus un h√¥te est injoignable longtemps, plus les tentatives vers cet h√¥te sont espac√©es.\nLes √©checs temporaires arrivent tout le temps, c\u0026rsquo;est quelque chose de normal dans le protocole SMTP, et en regardant les logs on verra tr√®s souvent des lignes telles que :\n4b3a6c195c1f6010 mta delivery evpid=8f26ea98359eccea from=\u0026lt;misc+bounces-4541-[redacted]=tin.it@opensmtpd.org\u0026gt; to=\u0026lt;[redacted]@tin.it\u0026gt; rcpt=\u0026lt;-\u0026gt; source=\u0026quot;45.76.46.201\u0026quot; relay=\u0026quot;62.211.72.32 (smtp.tin.it)\u0026quot; delay=0s result=\u0026quot;TempFail\u0026quot; stat=\u0026quot;421 \u0026lt;[redacted]@tin.it\u0026gt; Service not available - too busy\u0026quot; Il ne s\u0026rsquo;agit pas d\u0026rsquo;erreurs que l\u0026rsquo;on ne trouve que chez des petits serveurs personnels. Je connais deux Big Mailer Corps qui ont des machines en √©chec temporaire √† peu pr√®s en permanence, ils ont juste suffisamment de MX pour qu\u0026rsquo;une retransmission ait peu de chances de taper le m√™me MX deux fois de suite. Les mails sont g√©n√©ralement distribu√©s √† la premi√®re ou seconde tentative.\nPetit secret rien qu\u0026rsquo;entre nous : certains Big Mailer Corps se servent volontairement de ces √©checs temporaires pour √©valuer la r√©putation des √©metteurs. Ils g√©n√®rent ces erreurs √† des moments clefs qui leurs permettent certaines analyses sur lesquelles je reviendrai dans un futur article.\nIl y a beaucoup de choses √† dire sur les erreurs SMTP, mais r√©sumons l\u0026rsquo;essentiel pour cet article :\nIl existe un m√©canisme dans le protocole SMTP qui permet √† un MX destinataire de demander √† un MX √©metteur de retransmettre un message. La retransmission a lieu en arri√®re-plan, sans aucune action des utilisateurs, et elle peut provoquer un d√©lai dans la distribution.\nLe greylisting expliqu√© # Le spam est une industrie du volume.\nLes spammeurs ne sont pas int√©ress√©s par cibler des destinataires sp√©cifiques. Ils sont int√©ress√©s par cibler un grand nombre de destinataires pour que statistiquement cela augmente le nombre de destinataires qui se feront avoir.\nJe ne vais pas trop creuser ce sujet parce que c\u0026rsquo;est l\u0026rsquo;objet d\u0026rsquo;un autre article en r√©daction, n√©anmoins vous devez avoir √† l\u0026rsquo;esprit qu\u0026rsquo;il y a diff√©rents types de spammeurs. Alors que certains utilisent des MX tout ce qu\u0026rsquo;il y a de plus normaux qui honorent les demandes de retransmissions, beaucoup d\u0026rsquo;autres utilisent des outils ou des MX customis√©s pour NE PAS retransmettre.\nHonorer les retransmissions ralentit consid√©rablement l\u0026rsquo;√©mission pour un r√©sultat incertain. Garder trace de tous les destinataires en √©chec temporaire pendant des heures ou des jours pour pouvoir les retenter est loin d\u0026rsquo;√™tre int√©ressant, surtout s\u0026rsquo;il n\u0026rsquo;y a pas de certitude que la retransmission n\u0026rsquo;aboutira pas en un √©chec permanent de type \u0026ldquo;cet utilisateur n\u0026rsquo;existe pas\u0026rdquo;. Il faut conserver un √©tat pour se rappeller des tentatives en √©chec et conserver les destinataires dans la queue d\u0026rsquo;envoi. Directement ou indirectement cela impacte la capacit√© √† envoyer en masse.\nL\u0026rsquo;id√©e derri√®re le greylisting est tr√®s simple :\nLe greylisting d√©clenche un √©chec temporaire pour les MX auquels vous ne faites pas encore confiance et garde trace des tentatives de retransmission. Si la retransmission a lieu trop t√¥t elle est ignor√©e, les spammers ne peuvent pas faire une retransmission imm√©diate et doivent garder un √©tat. Si la retransmission a lieu trop tard‚Ä¶ et bien c\u0026rsquo;est trop tard, l\u0026rsquo;impl√©mentation peut faire un bon nombre de choses depuis l\u0026rsquo;ajout en blacklist √† la d√©gradation de la r√©putation, en passant par un nouveau tour de greylisting, encore et encore et encore, ‚Ä¶ Le r√©sultat est que pour passer le greylisting, les spammeurs sont contraints de conserver un √©tat et de se comporter comme des impl√©mentations correctes du point de vue de la RFC. C\u0026rsquo;est en conflit direct avec l\u0026rsquo;√©conomie de l\u0026rsquo;envoi de masse.\nD\u0026rsquo;un autre c√¥t√©, les MX qui respectent la RFC vont naturellement retenter de nombreuses fois et finir par faire une tentative dans la bonne fen√™tre de temps pour √™tre whitelist√©s.\nLe greylisting ne permet pas de se pr√©munir des spammeurs qui ont compromis des MX l√©gitimes, ni de ceux qui envoient √† l\u0026rsquo;aide d\u0026rsquo;outils qui acceptent le co√ªt de la retransmission. Il permet par contre d\u0026rsquo;√©liminer la plus grosse partie du spam : celle qui provient de machines infect√©es et transform√©es en bots √† spam, ou de scripts dont le seul but est d\u0026rsquo;envoyer un maximum possible avant qu\u0026rsquo;un h√©bergeur ou un administrateur ne s\u0026rsquo;en rende compte.\nComment le greylisting fonctionne habituellement # Il y a diff√©rentes solutions de greylisting et elles ne fonctionnent pas toutes pareil.\nL\u0026rsquo;id√©e g√©n√©rale est que vous avez une base de donn√©e qui garde trace des demande de retransmissions et de la fen√™tre de temps durant laquelle une tentative est consid√©r√©e comme valide pour un MX. En revanche, la mani√®re dont sont comptabilis√©es les tentatives d\u0026rsquo;un MX varie d\u0026rsquo;une solution √† une autre. Certaines solutions ne regardent que l\u0026rsquo;adresse IP source, alors que d\u0026rsquo;autres vont √©galement regarder le MAIL FROM et/ou le RCPT TO. Dans certains cas que j\u0026rsquo;ai pu observer, la solution regardait √©galement l\u0026rsquo;ent√™te Message-ID.\nLa solution spamd(8) d\u0026rsquo;OpenBSD va par exemple garder trace de l\u0026rsquo;adresse IP source, le nom d\u0026rsquo;h√¥te utilis√© lors de la phase d\u0026rsquo;identification HELO/EHLO, l\u0026rsquo;√©metteur d\u0026rsquo;envelope (MAIL FROM) et le destinataire d\u0026rsquo;envelope (RCPT TO). Pour passer le greylisting, un MX doit faire une retransmission dans la bonne fen√™tre de temps, en provenance de la m√™me IP source, en utilisant le m√™me nom d\u0026rsquo;h√¥te √† l\u0026rsquo;identification, depuis le m√™me √©metteur et pour le m√™me destinataire.\nLe probl√®me avec le greylisting et les Big Mailer Corps # Pour de petits √©metteurs, le greylisting marche tr√®s bien parce que la plupart utilisent le m√™me MX pour le trafic entrant et sortant. Le MX vous contacte, il lui est demand√© de retenter plus tard, il est accept√© lorsqu\u0026rsquo;il revient une minute plus tard.\nEnsuite, vous avez Gmail / Yahoo / Outlook / ‚Ä¶ qui non seulement disposent de MX diff√©rents pour le trafic entrant et sortant, mais ont √©galement des douzaines et des douzaines de MX sortants. La situation devient la suivante : un MX vous contacte, il lui est demand√© de retenter plus tard, mais vous ne voyez jamais de retransmission de ce MX puisque c\u0026rsquo;est un autre qui a retent√© et √† qui il a √©t√© demand√© de retenter plus tard, etc‚Ä¶\nLe greylisting avec ces h√¥tes est inutilisable et r√©sulte en des mails qui peuvent arriver avec plusieurs heures ou jours de retard, s\u0026rsquo;ils n\u0026rsquo;expirent pas tout simplement avant de vous atteindre.\nMais en m√™me temps, le greylisting emp√™che une grande quantit√© de nuisibles de vous atteindre en tuant le trafic de presque tous les scripts et les ordinateurs compromis. Donc pour le conserver, un grand nombre d\u0026rsquo;op√©rateurs de mails mettent en place des bricolages pour pouvoir continuer √† utiliser le greylisting pour les petits √©metteurs, tout en ne l\u0026rsquo;appliquant pas pour les Big Mailer Corps.\nStrat√©gies de contournement # J\u0026rsquo;utilise le pluriel mais en r√©alit√© toutes les strat√©gies reposent sur la m√™me id√©e : le whitelisting.\nLe contournement consiste √† trouver la liste des adresses IP des Big Mailer Corps pour leur donner un passe droit et leur permettre d\u0026rsquo;√©viter le greylisting.\nEst-ce que cela met en d√©faut le greylisting ? Pas vraiment. Le greylisting a pour but d\u0026rsquo;emp√™cher les MX ne respectant pas la RFC de vous atteindre, mais les Big Mailer Corps utilisent des MX qui respectent la RFC. Lorsque la retransmission a bien lieu plusieurs fois par le m√™me MX sortant, ils passent le test du greylisting sans souci.\nTr√®s bien, ajoutons-les √† la whitelist alors‚Ä¶ mais comment ?\nPendant un moment, j\u0026rsquo;ai utilis√© une approche na√Øve consistant √† whitelister le /24 de n\u0026rsquo;importe quel MX de Big Mailer Corps qui se retrouvait greylist√©. Apr√®s quelques temps, ma liste √©tait suffisamment grande pour que de nouveaux MX soient rarement hors de ma whitelist. C\u0026rsquo;√©tait p√©nible, √ßa ne couvrait pas le cas de nouveaux MX me contactant depuis de nouvelles plages d\u0026rsquo;adresses IP, et j\u0026rsquo;ai fini par aggr√©ger les listes de diff√©rentes personnes √† la mienne pour √™tre s√ªr d\u0026rsquo;en avoir le plus possible. Le r√©sultat √©tait une whitelist en augmentation constante.\nCe n\u0026rsquo;√©tait pas tr√®s malin parce que la plupart des Big Mailer Corps utilisent SPF. Ils ont un enregistrement DNS qui liste avec quelles adresses IP ils nous contactent, de fa√ßons √† ce que lorsque l\u0026rsquo;on re√ßoit un mail avec une adresse e-mail en provenance de chez eux, on puisse v√©rifier que c\u0026rsquo;est bien un de leurs MX autoris√© qui l\u0026rsquo;a transmis. Avec √ßa en t√™te, j\u0026rsquo;ai √©crit spfwalk (maintenant une sous-commande de smtpctl) en Janvier 2018, un outil qui permet de faire une √©num√©ration dans l\u0026rsquo;enregistrement SPF d\u0026rsquo;un domaine et extraire un maximum d\u0026rsquo;adresse IP possible. Il y a un article en anglais √† propos de spfwalk sur ce blog si √ßa vous int√©resse. L\u0026rsquo;outil avait pour vocation de remplacer mon approche na√Øve, il est loin d\u0026rsquo;√™tre parfait, j\u0026rsquo;ai fait mon mieux.\nLa fa√ßon dont fonctionne SPF permet de v√©rifier facilement si une adresse IP est autoris√©e, mais ne permet pas d\u0026rsquo;extraire facilement une liste d\u0026rsquo;adresse pour une v√©rification ult√©rieure. Par exemple, certaines politiques SPF s\u0026rsquo;attendent √† une r√©solution DNS inverse de l\u0026rsquo;adresse IP source pour voir si le nom d\u0026rsquo;h√¥te corresponds au domaine d\u0026rsquo;envoi. Dans ce type de politique SPF, il n\u0026rsquo;y a aucune adresse IP √† extraire pour mettre dans une whitelist. Donc‚Ä¶ l\u0026rsquo;√©num√©ration SPF fonctionne √† peu pr√®s tant que l\u0026rsquo;on ne tombe pas sur les politiques qui ne peuvent pas √™tre √©num√©r√©es. Pas de bol pour nous, l\u0026rsquo;un des Big Mailer Corps est dans le p√©rim√®tre.\nUn grand nombre de personnes sont tr√®s contentes avec l\u0026rsquo;√©num√©ration SPF. Elle am√©liore consid√©rablement la situation, mais elle reste un bricolage √† mon sens et je n\u0026rsquo;utilise plus cet outil parce qu\u0026rsquo;il ne me semble pas √™tre la bonne approche.\nLa preuve de concept filter-greylist # Le mois dernier, j\u0026rsquo;ai √©crit comme preuve de concept pour OpenSMTPD un filtre qui utilise une approche diff√©rente et qui est disponible sur Github.\nJe vais juste clarifier avant tout que je ne pr√©tends pas avoir invent√© cette m√©thode, elle m\u0026rsquo;a juste sembl√©e √™tre une bonne approche alors je l\u0026rsquo;ai impl√©ment√©e. Il se peut qu\u0026rsquo;on trouve d\u0026rsquo;autres impl√©mentations de cette m√™me id√©e ailleurs, j\u0026rsquo;avoue que je n\u0026rsquo;ai pas vraiment cherch√© tr√®s fort (pour ne pas dire \u0026ldquo;du tout\u0026rdquo;). Je ne sais donc pas s\u0026rsquo;il existe d\u0026rsquo;autres impl√©mentations similaires, et si elles existent je ne sais pas si mon impl√©mentation exploite l\u0026rsquo;id√©e de la m√™me mani√®re.\nL\u0026rsquo;id√©e de base est que nous ne voulons pas vraiment que les Big Mailer Corps soient exempt√©s de greylisting, ils en sont exempt√©s parce que l\u0026rsquo;on ne sait pas consid√©rer tous leurs MX sortants comme identiques dans un test de greylisting. En faisant une √©num√©ration SPF pour extraire leurs adresses IP, notre intention est simplement de consid√©rer que toutes les adresses IP de tous leurs MX sortants sont identiques pour nous : elles devraient pouvoir √™tre interchangeables dans un test de greylisting. En d\u0026rsquo;autres termes, ce que l\u0026rsquo;on veut c\u0026rsquo;est un SPF-aware greylisting (greylisting conscient de SPF).\nLa preuve de concept consid√®re qu\u0026rsquo;il y a deux types d\u0026rsquo;√©metteurs : ceux qui publient des enregistrements SPF et ceux qui n\u0026rsquo;en publient pas.\nLes MX qui ne publient pas d\u0026rsquo;enregistrement SPF sont greylist√©s par adresse IP source, comme cela serait le cas avec un greylisting traditionnel. Commes les Big Mailer Corps requi√®rent que les √©metteurs fournissent un enregistrement SPF pour ne pas d√©grader leur r√©putation, et parce que la plupart des gens veulent pouvoir √©mettre vers les Big Mailer Corps, la plupart des √©metteurs l√©gitimes ne devraient pas rentrer dans ce cas. Ne devraient rentrer dans ce cas que des petits √©metteurs qui n\u0026rsquo;√©mettent pas depuis un grand nombre d\u0026rsquo;adresse, et dont le greylisting serait identique qu\u0026rsquo;il soit par adresse IP ou domaine.\nEnsuite, nous avons les MX qui publient des enregistrements SPF, englobant l\u0026rsquo;ensemble des Big Mailer Corps pour des raisons √©videntes (difficile d\u0026rsquo;imposer SPF √† d\u0026rsquo;autres sans se l\u0026rsquo;imposer √† soi-m√™me). Pour ceux-ci, plut√¥t que d\u0026rsquo;avoir recours a un greylisting par IP source, on proc√®de √† un greylisting SPF du domaine.\nEn supposant que ce soit le premier email que nous recevons d\u0026rsquo;un MX, quand une nouvelle connexion arrive, le filtre garde trace de l\u0026rsquo;adresse IP source. La session SMTP progresse jusqu\u0026rsquo;√† la cr√©ation d\u0026rsquo;une transaction SMTP et le client fournit l\u0026rsquo;√©metteur d\u0026rsquo;envelope (MAIL FROM) :\nS: 220 in.mailbrix.mx ESMTP OpenSMTPD C: EHLO localhost S: [...] S: 250 in.mailbrix.mx Hello localhost [127.0.0.1], pleased to meet you C: MAIL FROM:\u0026lt;gilles@poolp.org\u0026gt; √Ä ce stade, le filtre peut faire une recherche SPF pour le domaine de l\u0026rsquo;√©metteur d\u0026rsquo;enveloppe, poolp.org. S\u0026rsquo;il ne trouve pas d\u0026rsquo;enregistrement SPF, il pourra garder trace de l\u0026rsquo;adresse IP source et demander une retransmission.\nS\u0026rsquo;il trouve un enregistrement SPF, il v√©rifie que l\u0026rsquo;adresse IP source est valide pour cet enregistrement. Si elle ne l\u0026rsquo;est pas, il peut supposer qu\u0026rsquo;elle ne provient pas du domaine √©metteur, le filtre va l√† encore proc√©der √† un greylisting par adresse IP source. Une approche plus stricte pourrait √™tre de rejeter la session, mais ce n\u0026rsquo;est pas le but d\u0026rsquo;un filtre de greylisting de d√©cider si la violation SPF est acceptable ou non.\nSi en revanche l\u0026rsquo;adresse IP source est valide pour l\u0026rsquo;enregistrement SPF, au lieu de garder trace de l\u0026rsquo;adresse IP source, le filtre garde trace du domaine et demande une retransmission.\nIgnorons dor√©navant le cas du greylisting par IP source pour nous concentrer sur le greylisting par domaine.\nLors d\u0026rsquo;une seconde connexion en provenance d\u0026rsquo;un domaine dont le filtre avait gard√© trace, si l\u0026rsquo;adresse IP source est valide pour l\u0026rsquo;enregistrement SPF, le filtre va pouvoir valider que le domaine √©tait d√©j√† en demande de retransmission depuis une autre addresse IP et consid√©rer le test comme r√©ussi. En d\u0026rsquo;autres termes plus simples, si Gmail vient d\u0026rsquo;une adresse IP, il est autoris√© √† venir d\u0026rsquo;une autre addresse IP d√®s lors que les deux sont d√©clar√©es dans l\u0026rsquo;enregistrement SPF.\nCette r√©solution SPF en live permet de garantir qu\u0026rsquo;il n\u0026rsquo;y a pas besoin de whitelister au pr√©alable les adresses IP. √Ä la place il est possible de whitelister des domaines ind√©pendamment des adresses IP avec lesquelles ils nous contacterons. Cette fa√ßon de fonctionner est de plus compatible avec les domaines qui ne fournissent pas d\u0026rsquo;enregistrement SPF, et qui d√©gradent en un greylisting par IP source.\nIl n\u0026rsquo;est pas possible d\u0026rsquo;impl√©menter cela dans un daemon comme spamd(8), la d√©cision de greylister ou de laisser la session progresser est prise au moment du MAIL FROM, l√† ou la redirection spamd(8) est d√©cid√©e par le firewall √† la connexion.\nEst-ce que √ßa peut √™tre am√©lior√© ? # Je ne sais pas trop mais je ne pense pas que l\u0026rsquo;on puisse radicalement am√©liorer l\u0026rsquo;id√©e.\nIl y a surement quelques petites am√©liorations √† faire √† la marge, mais je ne pense pas que l\u0026rsquo;on puisse faire de grosses grosses avanc√©es : un SPF-aware greylisting r√©sout le probl√®me du greylisting chez les Big Mailer Corps, ni plus, ni moins. Aujourd\u0026rsquo;hui avec ce filtre, je ne vois aucune diff√©rence de traitement entre Gmail et le petit domaine du coin. Les deux passent le greylisting assez rapidement et sans que l\u0026rsquo;on ne se rende vraiment compte qu\u0026rsquo;il y a eu retransmission.\nEn gardant en t√™te que le spam est une industrie du volume, je pense que du travail plus int√©ressant peut √™tre fait en augmentant le co√ªt de l\u0026rsquo;envoi de masse : de la m√™me mani√®re que les spammeurs n\u0026rsquo;aiment pas la retransmission, ils n\u0026rsquo;aiment PAS DU TOUT les h√¥tes lents parce qu\u0026rsquo;ils ont un impact √âNORME sur la capacit√© √† distribuer et sur la taille de la queue. J\u0026rsquo;ai d√©j√† impl√©ment√© des fonctionnalit√©s dans ce sens au sein d\u0026rsquo;autres filtres en corr√©lant les temps de r√©ponse √† la r√©putation d\u0026rsquo;un domaine.\nSi je passe plus de temps √† essayer de faire d\u0026rsquo;OpenSMTPD une cible difficile pour les spammeurs, il est certain que mes prochains travaux seront dans la lign√©e des sanctions par d√©lais.\n","date":"26 Janvier 2019","permalink":"/fr/posts/2019-12-26/spf-aware-greylisting-et-filter-greylist/","section":"Posts","summary":"TL;DR: - le greylisting est une bonne id√©e - ce n'est pas tr√®s pratique aujourd'hui - beaucoup de gens se passent du greylisting ou trouvent des contournements - le SPF-aware greylisting rend le greylisting utilisable √† nouveau Shout out a mes sponsors ‚ù§Ô∏è # Un GRAND MERCI √† mes sponsors sur github et patreon: votre soutien est grandement appr√©ci√© !","title":"SPF-aware greylisting et filter-greylist"},{"content":"","date":"26 Janvier 2019","permalink":"/fr/categories/technology/","section":"Categories","summary":"","title":"technology"},{"content":" TL;DR: - Pas de r√©sum√©, j'ai pass√© des heures √† traduire, vous allez passer des minutes √† lire ;) - OK‚Ä¶ J'ai expliqu√© avec BIEN TROP DE D√âTAILS comment mettre en place un serveur de mail Merci √† mes sponsors ! # Un √©norme merci aux gens qui me sponsorisent sur patreon ou github.\nO√π est-ce que j\u0026rsquo;ai d√©j√† lu √ßa ? # En Ao√ªt, j\u0026rsquo;ai publi√© un petit article intitul√© \u0026ldquo; You should not run your mail server because mail is hard\u0026rdquo; (\u0026ldquo;Vous ne devriez pas h√©berger votre serveur de mail parce que c\u0026rsquo;est dur\u0026rdquo;) qui √©tait, en gros, mon opinion sur les diff√©rentes raisons qui poussent les gens √† d√©courager l\u0026rsquo;h√©bergement de mails. De mani√®re tr√®s inattendue, l\u0026rsquo;article est devenu assez populaire, atteignant 100K lectures et continuant √† recevoir des visites et des commentaires plusieurs mois apr√®s sa publication.\nEn Septembre, j\u0026rsquo;ai publi√© un autre article beaucoup plus long intitul√© \u0026ldquo; Setting up a mail server with OpenSMTPD, Dovecot and Rspamd\u0026rdquo; (\u0026ldquo;Installer un serveur de mail avec OpenSMTPD, Dovecot et Rspamd\u0026rdquo;) qui d√©crivait pas √† pas, de fa√ßon tr√®s d√©taill√©e, les √©tapes pour installer un serveur de mail complet jusqu\u0026rsquo;√† la livraison des e-mails en bo√Æte de r√©ception chez un gros h√©bergeur de mail am√©ricain. L\u0026rsquo;article est devenu lui aussi plut√¥t populaire, sans pour autant atteindre le niveau du pr√©cedent article moins technique et sp√©cifique, mais atteignant 40K lectures et continuant √©galement √† recevoir des visites et des commentaires plusieurs mois apr√®s la publication. Le contenu que vous vous appr√™tez √† lire est la traduction de cet article technique.\nC\u0026rsquo;est mon second article r√©dig√© en fran√ßais depuis des ann√©es, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nCet article est DENSE parce que je vais vous tenir la main √† un niveau frisant l\u0026rsquo;absurdit√© en expliquant chacune de mes actions et le pourquoi du comment. D\u0026rsquo;un point de vue purement technique, sans explications, l\u0026rsquo;article pourrait probablement tenir en quelques paragraphes.\nN\u0026rsquo;h√©sitez pas √† partager la publication √† l\u0026rsquo;aide des icones en fin d\u0026rsquo;article et √† la commenter \u0026lt;3\nAh, et tant que je vous ai sous la main, je vous recommande chaudement la lecture de mon article non technique \u0026ldquo;D√©centralisons SMTP pour le bien commun\u0026rdquo; qui aborde certaines des raisons pour lesquelles il nous faut davantage de serveurs de mail.\nBonne lecture !\nCet article est pour les techies et les sysadmins # L\u0026rsquo;auto-h√©bergement requiert un minimum de connaissances et de motivation. Ce n\u0026rsquo;est pas un truc qui se fait en deux clics, il vous faut des connaissances minimales et avoir l\u0026rsquo;envie d\u0026rsquo;y d√©dier un peu de votre temps. Si vous n\u0026rsquo;avez jamais touch√© une zone DNS ou si vous pensez que prendre une heure pour configurer quelque chose est une t√¢che difficile, alors autant vous pr√©venir de suite : √ßa ne va pas √™tre simple. Je ne vous recommande pas vous lancer dans l\u0026rsquo;aventure sauf si vous VOULEZ avoir √† apprendre une tonne de trucs.\nSi vous √™tes un sysadmin familier avec le travail de sysadmin, alors la plupart de votre travail de sysadmin est d√©j√† consid√©rablement plus dur que mettre en place une instractructure mail. Pour vous, le mail ne sera pas quelque chose de difficile.\nEHLO hypno.cat # Pour cet article, nous mettrons en place un serveur de mail pour hypno.cat, un petit site web pour mon (hypoth√©tique) activit√© prosp√®re d\u0026rsquo;hypnopraticien. J\u0026rsquo;ai enregistr√© ce domaine il y a plusieurs ann√©es parce que j\u0026rsquo;aimais bien le nom mais il n\u0026rsquo;a jamais √©t√© utilis√© pour quoi que ce soit d\u0026rsquo;autre que l\u0026rsquo;h√©bergement d\u0026rsquo;un merveilleux fichier anim√©.\nGoogle, Bing et Yahoo le connaissent ; on ne sait pas trop comment (je vais du moins faire semblant de ne pas savoir) et ont index√© la page d\u0026rsquo;accueil, du coup ils ne consid√®rent pas que ce domaine vient d\u0026rsquo;√™tre achet√© par un spammer pour imm√©diatement envoyer du mail, mais il reste virtuellement inconnu sur internet parce qu\u0026rsquo;il n\u0026rsquo;a aucun contenu, ne fais aucun lien, n\u0026rsquo;est link√© depuis nul part, et n\u0026rsquo;a jamais √©mis ou re√ßu de mail depuis ou vers personne. C\u0026rsquo;est un d√©tail plut√¥t important qui montre que l\u0026rsquo;√¢ge d\u0026rsquo;un domaine √† un impact sur la r√©putation, mais √ßa reste un crit√®re parmi d\u0026rsquo;autres, on reparlera r√©putation dans un futur article.\nJe vais le mettre en place au fur et √† mesure que j\u0026rsquo;√©cris cet article, depuis le moment o√π j\u0026rsquo;ai d√©marr√© un nouveau VPS jusqu\u0026rsquo;au moment o√π j\u0026rsquo;ai pu √©changer un mail dans les deux sens avec mon compte Gmail. J\u0026rsquo;ai choisi Gmail parce qu\u0026rsquo;il est sur-repr√©sent√© dans la population et qu\u0026rsquo;un nombre important de personnes se sont plains de probl√®mes de distribution l√†-bas. Tr√®s personnellement, je pense que Outlook est bien pire en terme d\u0026rsquo;interop√©rabilit√©, mais gardons √ßa pour un futur article peut-√™tre.\nLes services de mail pour hypno.cat vont fournir du mail entrant et sortant s√©curis√©s par TLS. Ils vont permettre de soumettre des messages depuis l\u0026rsquo;application Gmail de mon smartphone pour ne pas changer les habitudes de mes utilisateurs. Je pourrais tout aussi bien fournir un webmail, avec Rainloop ou Roundcube, ou installer un client lourd comme Thunderbird ou mutt. N\u0026rsquo;importe quel client fonctionnera ; donc je ne vais pas couvrir cette partie. Il y a de nombreuses alternatives et plusieurs articles existants sur internet pour couvrir leur mise en place. Il y a m√™me des techniques pour assister les clients √† automatiquement d√©couvrir leur configuration, mais tout √ßa reste hors du p√©rim√®tre de mon article, je ne me fais pas de soucis vous allez trouver tout seul.\nMon mail sortant passera les v√©rifications basiques de Gmail, plus pr√©cis√©ment SPF, DKIM et DMARC, qui sont plus que suffisant pour laisser le mail arriver en inbox. Il est possible de faire beaucoup plus, mais le but de cet article est de trouver le bon √©quilibre entre faire assez de travail pour avoir bonne allure face aux autres serveurs et rester simple.\nLe mail entrant sera filtr√© pour r√©duire la quantit√© de spam, soit en tuant les connexions de mauvais √©metteurs √©vidents d√®s qu\u0026rsquo;ils sont d√©tect√©s, soit en proposant une classification du Spam dans un r√©pertoire d√©di√© pour √©viter de saturer la boite de r√©ception.\nJe pourrais m\u0026rsquo;arr√™ter l√† parce que c\u0026rsquo;est d√©j√† un setup assez int√©ressant, mais je vais rajouter un peu de configuration pour apprendre √† Dovecot √† entrainer le filtre antispam. Il apprendra √† reconnaitre le Spam lorsque je d√©placerai un message dans le r√©pertoire Spam, et √† reconnaitre le mail l√©gitime lorsque je d√©placerai un message hors du r√©pertoire Spam. Cette partie est un peu plus complexe parce qu\u0026rsquo;elle d√©pend de Sieve qui est loin d\u0026rsquo;√™tre un bijou d\u0026rsquo;ing√©nierie. Si vous vous moquez de l\u0026rsquo;apprentissage, vous pouvez sauter cette partie ; j\u0026rsquo;ai fait sans pendant plus de dix ans. C\u0026rsquo;est un truc sympa √† avoir mais loin d\u0026rsquo;√™tre une obligation ; c\u0026rsquo;est juste mon petit cadeau bonus dans cet article.\nPr√©-requis # Le premier pr√©-requis est de savoir o√π vous allez faire tourner votre serveur de mail.\nAvec la propagation des connexions permanentes type ADSL ou FTTH (fibre), une connexion √† domicile peut √™tre tentante mais ce n\u0026rsquo;est pas une bonne id√©e parce que les espaces d\u0026rsquo;adressage IP des FAI sont souvent blacklist√©s, ou souffrent d\u0026rsquo;une tr√®s mauvaise r√©putation de d√©part. De plus, de nombreux FAI bloquent le trafic SMTP sortant pour √©viter que les machines personelles compromises se transforment en bot √† spam. Pour moi, la meilleure option est de louer un serveur d√©di√© ou un VPS depuis une soci√©t√© d\u0026rsquo;h√©bergement apr√®s s\u0026rsquo;√™tre assur√© que le trafic SMTP sortant est autoris√© l√†-bas.\nJ\u0026rsquo;ai lou√© mes serveurs d√©di√©s chez online.net ces douze derni√®res ann√©es et je suis extr√™mement satisfait. Vous trouverez m√™me sur ce blog des instructions (en anglais) pour faire tourner OpenBSD sur leurs serveurs comme ce n\u0026rsquo;est pas support√© nativement. Ils ne filtrent pas SMTP, ce qui est bien parce que vous pouvez faire tourner un serveur de mail imm√©diatement, mais les adresses IP peuvent avoir √©t√© utilis√©es pr√©alablement par de mauvais √©metteurs et il vous faudra les tester. Si l\u0026rsquo;adresse IP qui vous est automatiquement allou√©e n\u0026rsquo;est pas bonne, soit il va falloir bucher pour gagner en r√©putation, soit il vous faudra en commander une additionelle en prenant bien le soin de la choisir dans un autre range, apr√®s avoir v√©rifi√© qu\u0026rsquo;elle n\u0026rsquo;est pas dans une blacklist, ou qu\u0026rsquo;elle ne souffre pas d√©j√† d\u0026rsquo;une mauvaise r√©putation.\nAlternativement, pour les besoins d\u0026rsquo;une offre commerciale que je suis en train de monter, j\u0026rsquo;ai commenc√© √† construire une infrastructure sur vultr.com (lien de parrainage). Je ne suis l√† bas que depuis quelques mois et je changerai peut-√™tre d\u0026rsquo;avis, mais pour l\u0026rsquo;instant j\u0026rsquo;en suis tr√®s satisfait. L√†-bas, SMTP est filtr√© par d√©faut et il faut ouvrir un ticket et expliquer quel est le projet pour le trafic mail. J\u0026rsquo;ai expliqu√© que je ne cherchais pas √† devenir ESP et que je n\u0026rsquo;allais pas envoyer de mail commercial de masse mais plut√¥t g√©rer de l\u0026rsquo;h√©bergement ; ils ont √©t√© tr√®s serviables et m\u0026rsquo;ont retir√© le filtrage le jour m√™me.\nPeu importe o√π le serveur de mail sera h√©berg√©, ce que vous devez v√©rifier c\u0026rsquo;est que :\nl\u0026rsquo;h√©bergeur n\u0026rsquo;a pas un passif avec l\u0026rsquo;h√©bergement de spammers et qu\u0026rsquo;il autorise SMTP vous avez une adresse IP d√©di√©e au mail vous avez le contr√¥le du reverse DNS pour cette adresse IP votre adresse IP n\u0026rsquo;est pas d√©j√† sur des blacklists Tant que ces pr√©-requis sont respect√©s, vous ne devriez pas avoir trop de probl√®mes.\nComme personne n\u0026rsquo;aime perdre de mails, il est aussi judicieux de se pr√©parer aux incidents. On s\u0026rsquo;en prot√®ge en utilisant un serveur secondaire pour prendre le trafic lorsque le primaire est down, ou pour re-router le trafic lorsque le primaire est en incapacit√© de router correctement. Je ne vais pas couvrir ce sujet parce que ce n\u0026rsquo;est pas tr√®s complexe, il s\u0026rsquo;agit d\u0026rsquo;installer un second serveur qui route son trafic vers le premier et de faire le bon enregistrement DNS, apr√®s avoir lu cet article vous devriez vous en sortir seul.\nCEPENDANT, un grand nombre de personnes ont mentionn√©s s\u0026rsquo;√™tre d√©j√† fait blacklister et avoir perdu du mail, donc je pense que c\u0026rsquo;est le bon moment pour donner ce conseil : n\u0026rsquo;h√©bergez pas vos diff√©rents serveurs au m√™me endroit. Vous ne voulez pas avoir tous vos serveurs au m√™me endroit s\u0026rsquo;il y a une panne de courant ou de r√©seau, et vous voulez aussi √©viter que si votre range IP est blacklist√© en dommage collat√©ral d\u0026rsquo;un voisin malveillant, l\u0026rsquo;adresse IP de votre serveur secondaire est \u0026ldquo;suffisamment √©loign√©e\u0026rdquo; pour ne pas √™tre blacklist√©e aussi. De cette fa√ßon, si votre serveur primaire est en incapacit√© temporaire d\u0026rsquo;√©mettre √† cause d\u0026rsquo;un blocage, vous pouvez re-router votre trafic au-travers de votre serveur secondaire le temps que le probl√®me soit r√©solu.\nJ\u0026rsquo;ai personellement eu √† g√©rer un seul blocage sur mon propre setup (bien plus en dehors) durant ces dix derni√®res ann√©es. C\u0026rsquo;est un peu chiant parce que les incidents tombent toujours au mauvais moment et que ce n\u0026rsquo;est jamais fun, mais j\u0026rsquo;ai re-rout√© le trafic au-travers d\u0026rsquo;un serveur secondaire pour le r√©tablir, rempli un formulaire de d√©listage en apportant la preuve que j\u0026rsquo;√©tais un √©metteur l√©gitime, puis re-rout√© le trafic par mon serveur primaire une fois le probl√®me r√©solu. On est tr√®s loin du probl√®me insurmontable qu\u0026rsquo;en font un certain nombre de personnes.\nPas de stress pour ceux qui ont un plan pour les pannes avant qu\u0026rsquo;elles ne surviennent.\nLa stack technique # Je vais d√©marrer un nouveau VPS chez vultr.com (toujours un lien de parrainage), installer la derni√®re version d\u0026rsquo; OpenBSD ( snapshot) parce que c\u0026rsquo;est mon syst√®me de pr√©f√©rence (installation non couverte dans cet article), et construire mon syst√®me de mail par dessus. Je vais partir du principe que nous sommes sous OpenBSD tout le reste de cet article, mais √† l\u0026rsquo;exception de certaines commandes sp√©cifiques pour installer des packages, la configuration est tr√®s similaire d\u0026rsquo;un syst√®me √† un autre. Si vous √™tes assez grands pour faire tourner un serveur de mail, vous √™tes assez grands pour adapter des chemins, remplacer doas par sudo, et sinon‚Ä¶ installez OpenBSD !\nPour la couche SMTP, qui est en charge de transf√©rer des messages entre deux h√¥tes ind√©pendemment de la mani√®re dont les utilisateurs vont y acc√©der, j\u0026rsquo;utiliserais le logiciel OpenSMTPD. Il s\u0026rsquo;agit du serveur SMTP par d√©faut pour le syst√®me d\u0026rsquo;exploitation OpenBSD et il y a une version portable disponible sur Github avec des instructions pour le construire. Il est √©galement disponible dans les d√©p√¥ts de packages de diff√©rents syst√®mes et distributions Linux, peut-√™tre tout juste √† un pkg, un rpm ou un apt de vous.\nLes instructions de cet article sont pour la version 6.6.0 ou ult√©rieure, elles ne fonctionneront pas sur des versions pr√©c√©dentes. Si votre syst√®me ne fournit pas de package √† jour, vous pouvez tenter de demander au mainteneur de le mettre √† jour ou alors tenter d\u0026rsquo;en devenir mainteneur. Il vous faudra construire le package manuellement √† partir du dernier tag contenant un p, pour portable, dans son nom sur Github.\nPour la couche IMAP, qui permet aux utilisateurs de r√©cup√©rer les messages qu\u0026rsquo;ils ont re√ßus et y acc√©der depuis leurs smartphones ou webmail, j\u0026rsquo;utiliserais la derni√®re version de Dovecot. J\u0026rsquo;utiliserai √©galement le package Dovecot-Pigeonhole, qui permettera d\u0026rsquo;entra√Æner notre solution antispam en lui faisant apprendre ce qui est du Spam et ce qui est du Ham. Si vous souhaitez utiliser un client console, en ssh, comme mutt par exemple, pas besoin de cette couche car OpenSMTPD peut distribuer dans une boite mail locale √† laquelle les clients mail peuvent acc√©der en direct. Dans cet article, nous configurerons IMAP parce que nous voulons que les mails puissent √™tre consult√©s depuis un smartphone comme une personne lambda.\nEnfin, pour la couche de filtrage du spam, j\u0026rsquo;utiliserai l\u0026rsquo;excellent Rspamd qui est bien plus qu\u0026rsquo;une simple solution antispam. Il fournit des m√©thodes de filtrage moderne, mais permet √©galement l\u0026rsquo;int√©gration de filtrage antivirus, de signature DKIM, et d\u0026rsquo;une tonne de modules que vous pouvez choisir d\u0026rsquo;activer ou non pour r√©gler plus finement votre setup. Dans cet article, nous utiliserons tout simplement ses capacit√©s de filtrage du Spam et de signature DKIM, le strict minimum dont nous avons besoin.\nMe rendre accessible # SMTP est tr√®s √©troitement li√© avec DNS et les autres h√¥tes d√©pendent de recherches DNS pour trouver quelle machine g√®re le mail de votre domaine. C\u0026rsquo;est fait au-travers de la recherche d\u0026rsquo;enregistrements MX (Mail eXchanger), donc le minimum √† faire pour que SMTP fonctionne est de d√©clarer un enregistrement MX pour votre domaine. Pour hypno.cat, la zone contiendra ce qui suit :\n;; un enregistrement A (et AAAA pour IPv6) est d√©clar√© pour nommer le serveur de mail mail.hypno.cat A 217.69.8.253 mail.hypno.cat AAAA 2001:19f0:6801:867:5400:01ff:fee7:7af7 ;; un enregistrement MX est d√©clar√© pour dire au monde que mail.hypno.cat g√®re le ;; mail pour hypno.cat ;; 0 est la pr√©f√©rence maximale, si nous avions un serveur secondaire il aurait un ;; nombre sup√©rieur hypno.cat. MX 0 mail.hypno.cat. ;;hypno.cat. MX 10 mail-backup.hypno.cat. Je peux m\u0026rsquo;assurer que tout est correct en utilisant host et dig pour v√©rifier que le nom r√©soud et que la recherche MX retourne bien le bon nom :\n$ host mail.hypno.cat mail.hypno.cat has address 217.69.8.253 mail.hypno.cat has IPv6 address 2001:19f0:6801:867:5400:1ff:fee7:7af7 $ dig -t MX hypno.cat +short 0 mail.hypno.cat. √Ä ce stade et avec ces enregistrements DNS, les autres serveurs de mail peuvent d√©j√† trouver quel serveur est responsable pour hypno.cat, et le contacter quand ils veulent envoyer du mail √† n\u0026rsquo;importe quelle adresse mail de ce domaine.\nMe faire bien voir # √ätre joignable n\u0026rsquo;est pas suffisant parce qu\u0026rsquo;aujourd\u0026rsquo;hui, vous DEVEZ avoir un reverse DNS (rDNS) ET un Forward-Confirmed rDNS (FCrDNS).\nIl y a une raison derri√®re cela. Un grand nombre d\u0026rsquo;h√¥tes qui √©mettent du spam sont des machines compromises, avec une grande portion d\u0026rsquo;entre elles qui sont des ordinateurs personnels derri√®re des connexions r√©sidentielles. Beaucoup de ces connexions n\u0026rsquo;ont pas de rDNS ou de FCrDNS, ou ont des rDNS qui ressemblent √† des patterns d\u0026rsquo;IP allou√©es dynamiquement (ex. : 123.123.123.123.dyn.adsl.example.com).\nComme il s\u0026rsquo;agit de machines compromises individuellement, et non de machines dont la configuration est sous le contr√¥le total des spammers, les rDNS et FCrDNS ne peuvent pas √™tre configur√©s‚Ä¶ il en r√©sulte que la configuration de rDNS et FCrDNS est devenu une preuve de travail : il faut un rDNS et un FCrDNS correctement configur√© et ne ressemblant pas √† une allocation dynamique. Chez certains Big Mailer Corps, il s\u0026rsquo;agit de r√®gles claires, d√©crites dans les guidelines, pour d\u0026rsquo;autres on le d√©couvre par la sanction. Dans tous les cas, il s\u0026rsquo;agit du STRICT MINIMUM ; assurez-vous que vos noms d\u0026rsquo;h√¥tes ressemblent √† un VRAI nom de serveur de mail (ex. : mail.hypno.cat, et non pas www.hypno.cat).\nLe rDNS est g√©n√©ralement hors de votre contr√¥le parce que dans une zone un peu sp√©ciale, arpa, g√©r√©e par le propri√©taire de l\u0026rsquo;adresse IP (en g√©n√©ral votre h√©bergeur). Les FAI ne vous laissent pas toujours les configurer ; mais les h√©bergeurs de serveurs n\u0026rsquo;ayant pas vraiment d\u0026rsquo;autres choix, fournissent g√©n√©ralement un formulaire quelque part sur leurs espaces clients pour assigner un rDNS aux adresses qu\u0026rsquo;ils vous ont assign√©es :\nSi je configure mon rDNS pour avoir la m√™me valeur que l\u0026rsquo;enregistrement DNS configur√© plus haut, alors je passe automatiquement le test du FCrDNS. On peut le v√©rifier tr√®s simplement en faisant une recherche rDNS pour l\u0026rsquo;adresse IP :\n$ host 217.69.8.253 253.8.69.217.in-addr.arpa domain name pointer mail.hypno.cat. $ host 2001:19f0:6801:867:5400:1ff:fee7:7af7 7.f.a.7.7.e.e.f.f.f.1.0.0.0.4.5.7.6.8.0.1.0.8.6.0.f.9.1.1.0.0.2.ip6.arpa domain name pointer mail.hypno.cat. Puis cherchez l\u0026rsquo;adresse IP pour ce rDNS :\n$ host mail.hypno.cat mail.hypno.cat has address 217.69.8.253 mail.hypno.cat has IPv6 address 2001:19f0:6801:867:5400:1ff:fee7:7af7 Si les valeurs se retrouvent dans les deux sens, tout est d\u0026rsquo;√©querre.\nAnnoncer quelles machines sont autoris√©es √† √©mettre pour mon domaine # SPF est un m√©canisme qui permet pour un domaine destination de d√©terminer si la machine qui √©met √©tait autoris√©e pour le domaine √©metteur.\nLe m√©canisme est tr√®s simple, on ajoute un enregistrement DNS √† la zone de notre domaine qui d√©clare quels serveurs peuvent √©mettre. Quand le domaine destination re√ßoit un mail avec un √©metteur de notre domaine, il v√©rifie si l\u0026rsquo;adresse IP du serveur √©metteur en avait le droit.\nSPF n\u0026rsquo;est pas obligatoire pour SMTP mais c\u0026rsquo;est une des choses qui nous font para√Ætre l√©gitimes face aux destinataires. SPF est informatif par d√©faut ; ne pas passer un test SPF ou ne pas avoir d\u0026rsquo;enregistrement SPF n\u0026rsquo;implique pas qu\u0026rsquo;un mail termine en Spam ou soit d√©truit. Il est commun√©ment accept√© que l\u0026rsquo;absence d\u0026rsquo;un enregistrement SPF a un impact tr√®s n√©gatif sur la r√©putation d\u0026rsquo;un domaine, c\u0026rsquo;est m√™me explicitement dit dans les guidelines de certains Big Mailer Corps, et vu comme l\u0026rsquo;enregistrement est simple √† fournir‚Ä¶ il n\u0026rsquo;y a vraiment aucune excuse pour ne pas le faire.\nIl y a plusieurs fa√ßons de configurer SPF ; dans cet example, je vais simplement le configurer pour n\u0026rsquo;autoriser QUE mon serveur de mail √† envoyer du mail en mon nom :\nhypno.cat. IN TXT \u0026#34;v=spf1 mx -all\u0026#34; Si des h√¥tes re√ßoivent un mail avec un √©metteur @hypno.cat qui ne provient pas de mail.hypno.cat, ils pourront prendre la d√©cision (ou non) de rejeter le mail. Ils pourront en tout cas constater qu\u0026rsquo;il provient d\u0026rsquo;une machine qui n\u0026rsquo;√©tait pas autoris√©e et qu\u0026rsquo;ils ont le droit de le rejeter.\nProuver que j\u0026rsquo;ai autoris√© le message lui m√™me. # DKIM est un m√©canisme d\u0026rsquo;authentification par lequel on peut signer cryptographiquement les mails √©mis par notre serveur, prouvant qu\u0026rsquo;on les a vu passer et que l\u0026rsquo;on a pris la responsabilit√© de les laisser transiter. Les h√¥tes qui recoivent ces mails peuvent v√©rifier qu\u0026rsquo;ils √©taient bien autoris√©s en v√©rifiant la signature, permettant ainsi de d√©tecter des mails forg√©s hors du syst√®me de mail.\nComme SPF, c\u0026rsquo;est informatif par d√©faut et l\u0026rsquo;absence de signature DKIM ou une signature invalide ne veut pas dire qu\u0026rsquo;un mail ne sera pas distribu√©. En revanche, il est l√† aussi admis et d√©crit dans les guidelines que l\u0026rsquo;absence de DKIM aura un effet sur la r√©putation d\u0026rsquo;un domaine. Et comme configurer DKIM est facile, pas vraiment d\u0026rsquo;excuse pour ne pas le faire l√† non plus.\nC\u0026rsquo;est un petit peu plus complexe que pour SPF parce que, m√™me si √ßa d√©pend aussi de DNS, il faut g√©n√©rer une paire de cl√©s et publier la cl√© publique dans l\u0026rsquo;enregistrement DNS. Rien de bien foufou non plus.\nNous sommes en 2019. Je vais g√©n√©rer une cl√© RSA de 1024 bits ; je sais !\n\u0026mdash; BEGIN DIGRESSION \u0026mdash;\nLes cl√©s RSA 2048 bits ne rentrent pas dans un enregistrement DNS TXT et doivent √™tre tronqu√©es en deux enregistrements, mais tout le monde n\u0026rsquo;est pas capable de r√©associer ces cl√©s tronqu√©es, et vous pouvez perdre les b√©n√©fices de DKIM si l\u0026rsquo;h√¥te destination n\u0026rsquo;arrive pas √† utiliser votre cl√© publique partielle et consid√®re la signature invalide.\nEn ce qui me concerne, ces h√¥tes sont responsables et nous pouvons les ignorer ; mais comme le but de cet article est de permettre une interop√©rabilit√© maximale et que DKIM n\u0026rsquo;est pas pr√©sent ici pour s√©curiser quoi que ce soit, juste pour vous faire para√Ætre l√©gitime, on va juste regarder ailleurs en justifiant cette mauvaise pratique par le risque mod√©r√© de falsification de contenu quand il est utilis√© conjointement √† SPF.\nCe n\u0026rsquo;est pas une bonne mani√®re de raisonner mais DKIM a d\u0026rsquo;autres inconv√©nients et comme virtuellement tout le monde utilise du RSA 1024-bits. Je sugg√®re de laisser le d√©bat 1024 vs \u0026gt;= 2048 √† plus tard, lors que nous aurons d√©j√† r√©ussis √† √©changer correctement avec les Big Mailer Corps. Je prendrais juste le temps, sans pointer de doigt nul part, d\u0026rsquo;appuyer sur le fait que certaines soci√©t√©s dans la s√©curit√© qui travaillent dans l\u0026rsquo;industrie du mail ont (avaient ?) encore des probl√®mes avec les cl√©s 2048-bits en 2019. Des soci√©t√©s qui calculent des scores de r√©putation. Oh, la, belle, ironie !\nSi c\u0026rsquo;est un sujet d\u0026rsquo;inqui√©tude pour vous, vous pouvez exp√©rimenter la troncature des cl√© et voir si √ßa vous convient. Adapter mon exemple est trivial ; assurez vous juste d\u0026rsquo;avoir la cl√© tronqu√©e sur deux enregistrements TXT.\n\u0026mdash; END DIGRESSION \u0026mdash;\nJe cr√©e un r√©pertoire pour contenir les cl√©s :\n# mkdir /etc/mail/dkim Ensuite, la commande suivante va g√©n√©rer une paire de cl√© et extraire la cl√© publique de la cl√© priv√©e:\n# openssl genrsa -out /etc/mail/dkim/hypno.cat.key 1024 Generating RSA private key, 1024 bit long modulus ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶++++++ ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶++++++ e is 65537 (0x10001) # openssl rsa -in /etc/mail/dkim/hypno.cat.key -pubout -out /etc/mail/dkim/hypno.cat.pub writing RSA key # cat /etc/mail/dkim/hypno.cat.pub -----BEGIN PUBLIC KEY----- MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDThHqiM610nwN1nmV8OMc7PaPO uJWVGRDz5bWj4cRjTTmQYjJQd02xrydRNrRhjEKBm2mMDArNWjoM3jvN04ZifqJx DmKr7X8jsYi+MPEHz6wZxB8mayDK6glYTCyx//zl1luUdvm26PutA38K8cgnb7iT kfVP2OqK6sHAdXjnowIDAQAB -----END PUBLIC KEY----- Enfin, je g√©n√©re un enregistrement DNS TXT en retirant le blindage de la cl√© publique et en formattant le contenu pour qu\u0026rsquo;il soit comme suit :\n20190913._domainkey.hypno.cat.\tIN TXT \u0026#34;v=DKIM1;k=rsa;p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDThHqiM610nwN1nmV8OMc7PaPOuJWVGRDz5bWj4cRjTTmQYjJQd02xrydRNrRhjEKBm2mMDArNWjoM3jvN04ZifqJxDmKr7X8jsYi+MPEHz6wZxB8mayDK6glYTCyx//zl1luUdvm26PutA38K8cgnb7iTkfVP2OqK6sHAdXjnowIDAQAB;\u0026#34; Le nom de l\u0026rsquo;enregistrement est construit selon le motif : \u0026lt;selector\u0026gt;._domainkey.\u0026lt;domain\u0026gt;., o√π \u0026lt;selector\u0026gt; est un nom arbitraire choisi pour permettre √† plusieurs cl√©s de co-exister. J\u0026rsquo;aime bien utiliser la date √† laquelle j\u0026rsquo;ai g√©n√©r√© la paire de cl√©s, mais peu importe ce que vous choisissez, √©crivez le pour plus tard car nous en aurons besoin pour configurer la signature DKIM.\nDe plus, la cl√© publique n\u0026rsquo;a pas besoin de rester dans le r√©pertoire une fois qu\u0026rsquo;elle est publi√©e dans l\u0026rsquo;enregistrement DNS. Elle peut toujours √™tre d√©riv√©e de la cl√© priv√©e si nous en avons besoin, mais personnellement j\u0026rsquo;aime bien la garder pour la retrouver rapidement.\nFaites bien attention √† ce que la cl√© priv√©e ne soit pas en lecture pour tous car, pour une raison inconnue et pas tr√®s maline, OpenSSL pense que les cl√©s priv√©es doivent √™tre cr√©√©es en rw-r--r--.\nDire aux autres quoi faire en cas d\u0026rsquo;erreurs SPF et DKIM avec DMARC # SPF et DKIM sont tous les deux tr√®s int√©ressants, mais ils ne sont qu\u0026rsquo;informatifs, alors ils n\u0026rsquo;emp√™chent pas d\u0026rsquo;abuser de votre nom de domaine.\nDMARC permet de dire aux serveurs mails de destination ce que vous voulez qu\u0026rsquo;ils fassent des mails en apparence de votre domaine qui ratent les tests SPF et DKIM. Il permet par exemple de leur dire qu\u0026rsquo;ils doivent rejeter ces mails.\nIl n\u0026rsquo;y a pas d\u0026rsquo;indicateur clair : fournir une politique de rejet nous fait mieux voir que de fournir une politique sans action. Des exp√©rimentations semblent montrer qu\u0026rsquo;avoir un enregistrement a un impact positif par rapport √† n\u0026rsquo;en avoir aucun, m√™me si l\u0026rsquo;enregistrement dit que rien ne doit √™tre fait avec les erreurs SPF et DKIM. Il serait int√©ressant de mener une nouvelle exp√©rimentation √† ce sujet, mais en m√™me temps, il est plus simple de fournir une politique de rejet et de ne pas avoir √† se poser la question :-)\nLe format d\u0026rsquo;un enregistrement DMARC va bien au-del√† de cet article et vous trouverez de nombreux exemples dans n\u0026rsquo;importe quel moteur de cherche. Un enregistrement simple annoncera une politique (p=) de none (reject si vous voulez rejeter, quarantine si vous avez besoin de temps pour d√©cider). Le champ pourcentage (pct=) d√©clare combien de ces mails devraient √™tre sujets √† la politique DMARC, et le champ Reporting URI of Aggregates (rua=) est la destination des rapports DMARC (pour analyse avant de basculer de quarantine √† reject par exemple).\nJe vais ici cr√©er un enregistrement simple, un enregistrement qui fera que les Big Mailer Corps voient que nous nous int√©ressons √† DMARC m√™me si nous ne savons pas encore quoi en faire :\n_dmarc.hypno.cat. IN TXT \u0026#34;v=DMARC1;p=none;pct=100;rua=mailto:postmaster@hypno.cat;\u0026#34; Mon opinion est qu\u0026rsquo;il est pr√©f√©rable de basculer rapidement vers p=reject, apr√®s s\u0026rsquo;√™tre assur√© que les mails sont correctement sign√©s et que seul notre serveur de mail les √©met.\nObtenir un certificat pour TLS # Il y a plusieurs fa√ßons d\u0026rsquo;obtenir un certificat TLS. Je vais partir du principe que vous √™tes familiers avec l\u0026rsquo;h√©bergement d\u0026rsquo;autres services et que vous √™tes capable d\u0026rsquo;en obtenir un par votre registrar ou depuis letsencrypt. Si ce n\u0026rsquo;est pas le cas, vous trouverez des exemples √† foison sur n\u0026rsquo;importe quel moteur de recherche.\nSi vous savez g√©rer vos certificats, vous pouvez sauter √† la section suivante.\nComme je suis r√©ellement en train de mettre en place mail.hypno.cat, je ne serais pas en mesure de continuer cet article sans obtenir de certificat, donc en bonus pour les utilisateurs d\u0026rsquo;OpenBSD, je vais documenter la g√©n√©ration de mon certificat sur ma nouvelle installation.\nacme-client est un utilitaire pr√©sent dans le syst√®me de base et qui permet de demander ou renouveller des certificats depuis la console. Il d√©pend d\u0026rsquo;un challenge HTTP ; il doit donc √™tre en mesure d\u0026rsquo;√©crire dans un r√©pertoire qui soit accessible par HTTP. Et comme nous sommes chanceux‚Ä¶ OpenBSD contient un serveur httpd que l\u0026rsquo;on peut utiliser pour ce challenge. Et comme nous sommmes TR√àS chanceux‚Ä¶ OpenBSD fournit aussi un exemple de fichier de configuration que l\u0026rsquo;on peut utiliser sans gros changement.\nOn copie simplement le fichier d\u0026rsquo;example depuis /etc/example/httpd.conf vers /etc/httpd.conf, en rempla√ßant example.com par mail.hypno.cat et en supprimant le bloc TLS puisque seul le challenge nous interesse. Le fichier doit ressembler √† cela :\nserver \u0026#34;mail.hypno.cat\u0026#34; { listen on * port 80 location \u0026#34;/.well-known/acme-challenge/*\u0026#34; { root \u0026#34;/acme\u0026#34; request strip 2 } location * { block return 302 \u0026#34;https://$HTTP_HOST$REQUEST_URI\u0026#34; } } Le daemon httpd peut √™tre d√©marr√© comme suit :\n# rcctl -f start httpd httpd(ok) En ce qui concerne acme-client, c\u0026rsquo;est tr√®s simple, on copie √† nouveau le fichier d\u0026rsquo;exemple depuis /etc/example/acme-client.conf vers /etc/acme-client.conf, en rempla√ßant example.com par mail.hypno.cat et on doit se retrouver avec un bloc comme suit :\ndomain mail.hypno.cat { domain key \u0026#34;/etc/ssl/private/mail.hypno.cat.key\u0026#34; domain full chain certificate \u0026#34;/etc/ssl/mail.hypno.cat.fullchain.pem\u0026#34; sign with letsencrypt } √Ä ce stade, on se contente de lancer acme-client pour notre domaine :\n# acme-client -v mail.hypno.cat [‚Ä¶] acme-client: /etc/ssl/mail.hypno.cat.fullchain.pem: created Le certificat et les cl√©s sont cr√©√©s au bon endroit, il suffira par la suite d\u0026rsquo;ajouter les chemins dans OpenSMTPD et Dovecot.\nVous pouvez garder httpd en marche pour les renouvellements et appeller acme-client depuis un cron, vous pouvez l\u0026rsquo;√©teindre et renouveller d\u0026rsquo;une autre fa√ßon. Je vous laisse vous d√©brouiller ; vous trouverez comment faire avec l\u0026rsquo;aide de la page de manuel acme-client(1).\nInstaller et configurer Rspamd # Sur OpenBSD, Rspamd est packag√© et peut √™tre install√© d\u0026rsquo;une simple commande. Nous avons aussi besoin d\u0026rsquo;installer Redis qui sert √† stocker des statistiques pour Rspamd et son greylisting (entre autres), et √©galement filter-rspamd qui est un petit bout de code qui permets √† OpenSMTPD de travailler avec Rspamd. Ils existent √©galement sous forme de packages et peuvent √™tre install√©s en une seule commande.\nTout d\u0026rsquo;abord, on installe les packages :\nmail$ doas pkg_add redis rspamd opensmtpd-filter-rspamd [‚Ä¶] redis-4.0.14: ok rspamd-1.9.0: ok opensmtpd-filter-rspamd-0.1.1: ok The following new rcscripts were installed: /etc/rc.d/redis /etc/rc.d/rspamd See rcctl(8) for details. Rspamd est tr√®s configurable, si vous voulez faire des choses un peu funky je vous laisse lire la documentation. Pour cet article je me contenterai d\u0026rsquo;une utilisation tr√®s basique, comme c\u0026rsquo;est le cas sur mes propres machines :\nJe pourrais √©diter la configuration dans /etc/rspamd/actions.conf pour ajuster les seuils de mise en spam, mais les valeurs par d√©faut me conviennent alors je vous les montre juste :\nactions { reject = 15; # Reject when reaching this score add_header = 6; # Add header when reaching this score greylist = 4; # Apply greylisting when reaching this score (will emit `soft reject action`) [‚Ä¶] Mais ce que je veux vraiment c\u0026rsquo;est que Rspamd g√®re la signature DKIM parce que c\u0026rsquo;est un des pr√©-requis pour para√Ætre l√©gitime.\nOn le fait en fournissant une configuration dans /etc/rspamd/local.d/dkim_signing.conf pour faire correspondre √† notre domaine la cl√© DKIM g√©n√©r√©e plus t√¥t :\n# mkdir /etc/rspamd/local.d # cat \u0026lt;\u0026lt; EOF \u0026gt;/etc/rspamd/local.d/dkim_signing.conf allow_username_mismatch = true; domain { hypno.cat { path = \u0026#34;/etc/mail/dkim/hypno.cat.key\u0026#34;; selector = \u0026#34;20190913\u0026#34;; } } EOF La cl√© de configuration allow_username_mismatch est n√©cessaire parce que Rspamd attend des utilisateurs avec des noms de domaines, mais dans cette configuration OpenSMTPD authentifie de simples utilisateurs syst√®me. De plus, faites attention √† ce que le fichier contenant la cl√© DKIM soit autoris√© en lecture au groupe _rspamd.\n√Ä ce stade on est bon, Rspamd et Redis peuvent √™tre activ√©s pour qu\u0026rsquo;OpenBSD les d√©marre √† chaque reboot :\n# rcctl enable redis # rcctl enable rspamd Et on peut les d√©marrer imm√©diatement pour ne pas avoir √† attendre le prochain reboot :\n# rcctl start redis redis(ok) # rcctl start rspamd rspamd(ok) Configurer OpenSMTPD # OpenSMTPD est install√© par d√©faut sur OpenBSD donc aucune phase d\u0026rsquo;installation ici. Si vous utilisez un syst√®me d\u0026rsquo;exploitation diff√©rent, soit quelqu\u0026rsquo;un l\u0026rsquo;a packag√© et vous pouvez l\u0026rsquo;installer avec votre gestionnaire de paquets, ou vous pouvez le construire depuis les sources et l\u0026rsquo;installer en utilisant le code depuis le mirroir Github et en suivant les instructions de build.\nComme √©crit plus haut, ces instructions ne sont valides que pour la version 6.6.0 et ult√©rieures, les versions pr√©c√©dentes ne supportent pas les filtres et certaines des fonctionnalit√©s d√©crites ici.\nLa configuration par d√©fault d\u0026rsquo;OpenSMTPD est adapt√©e √† un serveur de mail local, n\u0026rsquo;acceptant pas de connexions de l\u0026rsquo;ext√©rieur, mais capable de laisser les utilisateurs locaux s\u0026rsquo;√©changer des messages et en √©mettre vers des h√¥tes distants.\nElle ressemble √† ce qui suit :\n# $OpenBSD: smtpd.conf,v 1.11 2018/06/04 21:10:58 jmc Exp $ # This is the smtpd server system-wide configuration file. # See smtpd.conf(5) for more information. table aliases file:/etc/mail/aliases # To accept external mail, replace with: listen on all # listen on lo0 action \u0026#34;local_mail\u0026#34; mbox alias \u0026lt;aliases\u0026gt; action \u0026#34;outbound\u0026#34; relay # Uncomment the following to accept external mail for domain \u0026#34;example.org\u0026#34; # # match from any for domain \u0026#34;example.org\u0026#34; action \u0026#34;local_mail\u0026#34; match from local for local action \u0026#34;local_mail\u0026#34; match from local for any action \u0026#34;outbound\u0026#34; Je voulais initialement mettre √† jour la configuration progressivement pour vous tenir par la main, mais cet article √† √©norm√©ment grossi depuis sa premi√®re version. Par souci de simplicit√©, je vais simplement mettre les 16 lignes de configuration et les commenter ensuite :\npki mail.hypno.cat cert \u0026#34;/etc/ssl/mail.hypno.cat.fullchain.pem\u0026#34; pki mail.hypno.cat key \u0026#34;/etc/ssl/private/mail.hypno.cat.key\u0026#34; filter check_dyndns phase connect match rdns regex { \u0026#39;.*\\.dyn\\..*\u0026#39;, \u0026#39;.*\\.dsl\\..*\u0026#39; } \\ disconnect \u0026#34;550 no residential connections\u0026#34; filter check_rdns phase connect match !rdns \\ disconnect \u0026#34;550 no rDNS is so 80s\u0026#34; filter check_fcrdns phase connect match !fcrdns \\ disconnect \u0026#34;550 no FCrDNS is so 80s\u0026#34; filter senderscore \\ proc-exec \u0026#34;filter-senderscore -blockBelow 10 -junkBelow 70 -slowFactor 5000\u0026#34; filter rspamd proc-exec \u0026#34;filter-rspamd\u0026#34; table aliases file:/etc/mail/aliases listen on all tls pki mail.hypno.cat \\ filter { check_dyndns, check_rdns, check_fcrdns, senderscore, rspamd } listen on all port submission tls-require pki mail.hypno.cat auth filter rspamd action \u0026#34;local_mail\u0026#34; maildir junk alias \u0026lt;aliases\u0026gt; action \u0026#34;outbound\u0026#34; relay helo mail.hypno.cat match from any for domain \u0026#34;hypno.cat\u0026#34; action \u0026#34;local_mail\u0026#34; match from local for local action \u0026#34;local_mail\u0026#34; match from any auth for any action \u0026#34;outbound\u0026#34; match from local for any action \u0026#34;outbound\u0026#34; C\u0026rsquo;est tout ce dont nous avons besoin pour notre configuration SMTP compl√®te.\nLes deux premi√®res lignes pki d√©clarent que mail.hypno.cat utilisera le certificat et la cl√© que nous avons g√©n√©r√©s plus t√¥t pour TLS.\nLes lignes filter appliquent un ensemble de filtres sur les connexions entrantes. check_dyndns filtrera si rDNS corresponds √† certains motifs. check_rdns filtrera s\u0026rsquo;il n\u0026rsquo;y a pas de rDNS. check_fcrdns filtrera si la correspondance FCrDNS √©choue. Il s\u0026rsquo;agit de filtres \u0026ldquo;internes\u0026rdquo; √† OpenSMTPD que vous pouvez ajuster pour filtrer diff√©rement, √† d\u0026rsquo;autres phases ou avec d\u0026rsquo;autres crit√®res.\nsenderscore est un filtre custom que vous pouvez installer soit depuis votre gestionnaire de paquets (pkg_add opensmtpd-filter-senderscore sur OpenBSD), ou obtenir depuis Github. Il n\u0026rsquo;est pas obligatoire mais je le trouve particuli√®rement utile et expliquerai pourquoi dans la prochaine section. Dans cette configuration, il rejettera un √©metteur si son senderscore est en dessous de 10, il junk-era le message (ajoutera un ent√™te X-Spam si le score est inf√©rieur √† 70), et pour mon plaisir personnel, ajoutera avant chaque r√©ponse un d√©lai inversement proportionnel √† la r√©putation de l\u0026rsquo;√©metteur pour ralentir les mauvais √©metteurs.\nrspamd est √©galement un filtre custom que nous avons install√© dans la pr√©cedente section. Il n\u0026rsquo;y a aucune configuration car il est enti√®rement control√© depuis Rspamd, il suffit donc de le d√©clarer.\nSi vous voulez √™tre plus conservateur et ne pas rejeter les mail pour √©viter des faux positifs, vous pouvez assigner l\u0026rsquo;action junk plut√¥t que disconnect aux filtres internes et supprimer l\u0026rsquo;option -blockBelow au filtre senderscore :\nfilter check_dyndns phase connect match rdns regex { \u0026#39;.*\\.dyn\\..*\u0026#39;, \u0026#39;.*\\.dsl\\..*\u0026#39; } junk filter check_rdns phase connect match !rdns junk filter check_fcrdns phase connect match !fcrdns junk filter senderscore proc-exec \u0026#34;filter-senderscore -junkBelow 70 -slowFactor 5000\u0026#34; De cette fa√ßon, au lieu de rejeter les sessions, OpenSMTPD va simplement junk les messages pour les faire atterrir en boite √† Spam. En regardant r√©guli√®rement ce qui atterri dans cette boite, vous pourrez gagner en confiance et adapter vos r√©glages pour trouver ceux qui vous conviennent.\nCes filtres simples, sans m√™me compter rspamd, sont suffisants pour tuer la plus grosse partie du spam. Chez moi, ils permettent de passer de plusieurs centaines de spam quotidiens √† une poign√©e. Le filtre rdns regex doit √™tre adapt√© en fonction du pays, vous pouvez trouver des motifs qui sont r√©currents chez vous et n\u0026rsquo;apparaissent jamais chez moi. Pour faciliter la maintenance, ils peuvent √™tre stock√©s dans un fichier √† raison d\u0026rsquo;un par ligne, en respectant la construction suivante :\ntable \u0026lt;dyndns\u0026gt; file:/etc/mail/path-to-my-regex-file filter check_dyndns phase connect match rdns regex \u0026lt;dyndns\u0026gt; junk Continuons √† diss√©quer la configuration.\nLa table aliases pointe vers un fichier d\u0026rsquo;alias sur deux colonnes. La colonne de gauche correspond √† la partie utilisateur d\u0026rsquo;une adresse e-mail que vous recevez ; la colonne de droite correspond √† l\u0026rsquo;utilisateur √† qui le mail doit √™tre livr√© (ex. : root: gilles). Il est recommand√© d\u0026rsquo;aliaser les adresses root, abuse et postmaster vers une adresse que vous lisez r√©ellement. Je ne le fais pas ici parce que je vais simplement d√©truire le setup une fois l\u0026rsquo;article fini, mais en ce qui vous concerne, faites le !\nEnsuite viennent les lignes listen. La premi√®re est le point d\u0026rsquo;attache que vont contacter les autres serveurs de mail qui souhaitent envoyer du mail vers hypno.cat. Elle est configur√©e pour offrir tls en utilisant les certificats et cl√©s pour mail.hypno.cat et pour filtrer les sessions entrantes avec mes filtres. La seconde est le point d\u0026rsquo;attache que vont contacter mes propres utilisateurs sur le port de submission, qui requiert TLS en utilisant les m√™mes certificats et cl√©s, mais √©galement l\u0026rsquo;authentification des utilisateurs syst√®me locaux (le d√©faut peut √™tre chang√©), et filtrant √†-travers le filtre rspamd uniquement dans le but de faire la signature DKIM de nos messages.\nLes lignes action d√©finissent les actions √† entreprendre avec les mails qui sont accept√©s dans le syst√®me. Une action locale permet de distribuer dans une maildir, en classifiant les spams dans un r√©pertoire sp√©cifique, et en r√©solvant les alias. Une seconde action permets de relayer les mails en s\u0026rsquo;annon√ßant en tant que mail.hypno.cat aux autres h√¥tes. Si le serveur disposait de plusieurs adresses IP, il serait possible d\u0026rsquo;assigner √† l\u0026rsquo;aide de l\u0026rsquo;option src celle √† utiliser, mais ici je n\u0026rsquo;ai qu\u0026rsquo;une seule adresse IP donc pas besoin de la sp√©cifier.\nEnfin, les lignes match repr√©sentent l\u0026rsquo;ensemble des r√®gles. Quand une enveloppe entre dans le serveur SMTP au travers d\u0026rsquo;un des points d\u0026rsquo;attache listen, elle est compar√©e s√©quentiellement √† chaque ligne match jusqu\u0026rsquo;√† trouver une correspondance ou rejet√©e si aucune correspondance n\u0026rsquo;est trouv√©e. Lorsqu\u0026rsquo;une correspondance est trouv√©e, l\u0026rsquo;action associ√©e √† la r√®gle est prise en compte. Les r√®gles de match sont tr√®s simples √† comprendre, je ne vais donc pas les expliquer ; vous devriez arriver √† comprendre seuls ce que signifie from any for domain \u0026quot;hypno.cat\u0026quot;, sans quoi vous ne devriez pas lire cet article en premier lieu.\nQuelques mots au sujet de SenderScore # SenderScore est une base de donn√©e de r√©putation IP qui associe un score entre 0 et 100 √† une adresse IP. Le score est li√© au volume et comportement observ√© depuis ces adresses IP, et m√™me si l\u0026rsquo;on ne sait pas COMMENT sont calcul√©s ces scores parce que la m√©thodologie n\u0026rsquo;est pas publique, un peu d\u0026rsquo;√©tude permet de confirmer que ces nombres ne sortent pas de nul part : ils sont corr√©l√©s au ratio de distribution et d\u0026rsquo;erreur chez diff√©rents Big Mailer Corps et il est possible d\u0026rsquo;influencer le score en changeant de comportement.\nIl est √©galement TR√àS clair que pour construire les scores de r√©putation, ils ont acc√®s √† des informations relatives aux sessions SMTP dont seuls les serveurs mails de destinations peuvent disposer, comme le volume de mails ou le ratio de destinataires accept√©s et refus√©s, observ√©s depuis une adresse, impliquant que ces informations sont obtenues directement depuis les Big Mailer Corps. Faites ce que vous voulez de cela.\nEn me basant sur MA compr√©hension, il s\u0026rsquo;agit d\u0026rsquo;un indicateur int√©ressant pour limiter la quantit√© de spam qui vous atteint. Je ne fait pas confiance √† cet indicateur concernant les bons scores (parce que je sais √† peu pr√®s contourner) mais j\u0026rsquo;y fais √âNORM√âMENT confiance en ce qui concerne les mauvais scores, parce qu\u0026rsquo;il faut vraiment faire un paquet de mauvaises choses en gros volume pour que le score se d√©grade. Si vous ne faites pas de mailing en masse, vous √™tes cens√©s √™tre soit inconnu de cette base de donn√©e ou avoir un score sup√©rieur √† 95, sinon il y a quelque chose qui d√©conne chez vous.\nTout le monde n\u0026rsquo;est pas convaincu par SenderScore et certains experts en d√©liverabilit√© disent que c\u0026rsquo;est du pipeau. J\u0026rsquo;ai personnellement fait tourner une exp√©rimentation sur plusieurs mois en graphant volume et r√©putation quotidienne, en comparant aux graphs de distribution. Mon opinion est contraire : il y a une correlation tr√®s significative qui permet clairement de classifier les √©metteurs. Je pense que la meilleure approche est d\u0026rsquo;utiliser le filtre pour junker, et non bloquer, pour d√©terminer par vous m√™me si vous en √™tes satisfait.\nSenderScore consid√®re que les √©metteurs devraient avoir une r√©putation sup√©rieure √† 70. Je pense pour ma part que les h√¥tes avec un score inf√©rieur √† 70 sont de bons candidats au junk, les h√¥tes avec un score inf√©rieur √† 10 sont des rejets √©vidents.\nInstaller et configurer Dovecot # OpenBSD dispose d\u0026rsquo;un paquet pour Dovecot qui peut √™tre install√© d\u0026rsquo;une simple commande :\nmail# pkg_add dovecot dovecot-2.3.7.2v0: ok The following new rcscripts were installed: /etc/rc.d/dovecot See rcctl(8) for details. New and changed readme(s): /usr/local/share/doc/pkg-readmes/dovecot [‚Ä¶] Et, specifiquement pour OpenBSD, en suivant les instructions du fichier readme, le fichier /etc/login.conf devrait contenir une classe dovecot pour augmenter les ressources autoris√©es √† Dovecot, gourmand en descripteurs de fichiers :\ndovecot:\\ :openfiles-cur=1024:\\ :openfiles-max=2048:\\ :tc=daemon: Cela fait, il n\u0026rsquo;y a plus grand chose √† faire √† part pointer Dovecot sur le certificat et la cl√© TLS g√©n√©r√©s plus t√¥t. On le fait en modifiant les cl√©s de configuration ssl_cert et ssl_key dans le fichier /etc/dovecot/conf.d/10-ssl.conf pour qu\u0026rsquo;elles soient comme suit :\nssl_cert = \u0026lt;/etc/ssl/mail.hypno.cat.fullchain.pem ssl_key = \u0026lt;/etc/ssl/private/mail.hypno.cat.key Puis dire √† Dovecot que les mails sont livr√©s dans le r√©pertoire ~/Maildir de chaque utilisateur puisque c\u0026rsquo;est l√† que OpenSMTPD les d√©posera. On le fait en modifiant la cl√© de configuration mail_location dans le fichier /etc/dovecot/conf.d/10-mail.conf pour qu\u0026rsquo;elle soit comme suit :\nmail_location = maildir:~/Maildir On est bon.\nLe daemon peut √™tre activ√© pour √™tre d√©marr√© √† chaque reboot, puis d√©marr√© imm√©diatement :\nmail# rcctl enable dovecot mail# rcctl start dovecot dovecot(ok) √Ä ce stade, il est possible de configurer n\u0026rsquo;importe quel client mail comme mutt, thunderbird ou m√™me l\u0026rsquo;application gmail sur Android, et utiliser mail.hypno.cat pour les mails entrants et sortants.\nApprendre √† Dovecot √† entrainer Rspamd # Vous avez lu jusqu\u0026rsquo;ici ? bien.\nCette section est une section bonus, elle n\u0026rsquo;est absolument pas n√©cessaire pour configurer votre serveur de mail, mais c\u0026rsquo;est un √©l√©ment que j\u0026rsquo;aime ajouter parce qu\u0026rsquo;il permet aux utilisateurs d\u0026rsquo;entrainer le filtre antispam d\u0026rsquo;une mani√®re √† laquelle ils sont habitu√©s : en d√©pla√ßant un mail vers la boite √† Spam, ou en appuyant sur un bouton \u0026ldquo;signaler un Spam\u0026rdquo;, \u0026ldquo;marquer comme Spam\u0026rdquo; ou peu importe comment il s\u0026rsquo;appelle dans l\u0026rsquo;interface utilis√©e. Le bon c√¥t√© est que cet √©l√©ment de configuration s\u0026rsquo;int√®gre avec IMAP, donc peu importe comment les mails sont consult√©s et depuis quel logiciel, l\u0026rsquo;action de marquer un mail comme Spam entra√Ænera automatiquement le filtre.\nC\u0026rsquo;est tr√®s simple en th√©orie : il suffit de brancher deux scripts, l\u0026rsquo;un qui g√®re le d√©placement dans la boite √† Spam, l\u0026rsquo;autre qui g√®re le d√©placement hors de la boite √† Spam. Les Big Mailer Corps utilisent des strat√©gies plus pouss√©es en d√©tectant les mails non ouverts, ceux d√©plac√©s directement en poubelle, etc‚Ä¶ mais d√©butons simple, il est toujours possible d\u0026rsquo;√©tendre ensuite.\nPour faire ce branchement, nous d√©pendont de Sieve qui est‚Ä¶ comment dire avec diplomatie‚Ä¶ un peu sur-con√ßu.\nCe n\u0026rsquo;est pas un √©l√©ment critique du setup, vous √™tes autoris√©s √† √©teindre vos cerveaux et suivre les instructions aveugl√©ment. Le pire qui puisse arriver ici est que l\u0026rsquo;entra√Ænement de la d√©tection ne marche pas.\nPour activer imap sieve, le package Pigeonhole doit √™tre install√©, encore une fois √† l\u0026rsquo;aide d\u0026rsquo;une simple commande :\nmail# pkg_add dovecot-pigeonhole dovecot-pigeonhole-0.5.7.2v1: ok [‚Ä¶] Et‚Ä¶ voici la partie la plus complexe, il faut configurer Dovecot pour activer imap_sieve et lui apprendre quels scripts utiliser pour quelles actions.\nD\u0026rsquo;abord, on active imap_sieve dans Dovecot en l\u0026rsquo;ajoutant dans la liste des plugins mails pour IMAP. C\u0026rsquo;est fait en mofifiant la cl√© de configuration mail_plugins dans le fichier /etc/dovecot/conf.d/20-imap.conf :\nprotocol imap { [‚Ä¶] mail_plugins = $mail_plugins imap_sieve [‚Ä¶] } Ensuite pour apprendre √† Dovecot √† entrainer Rspamd, on ajoute la section suivante dans le fichier /etc/dovecot/conf.d/90-plugin.conf, pour dire quel script sieve d√©clencher quand un mail est d√©plac√© vers ou hors du r√©pertoire Junk :\nplugin { sieve_plugins = sieve_imapsieve sieve_extprograms sieve_global_extensions = +vnd.dovecot.pipe +vnd.dovecot.environment imapsieve_mailbox1_name = Junk imapsieve_mailbox1_causes = COPY APPEND imapsieve_mailbox1_before = file:/usr/local/lib/dovecot/sieve/report-spam.sieve imapsieve_mailbox2_name = * imapsieve_mailbox2_from = Junk imapsieve_mailbox2_causes = COPY imapsieve_mailbox2_before = file:/usr/local/lib/dovecot/sieve/report-ham.sieve imapsieve_mailbox3_name = Inbox imapsieve_mailbox3_causes = APPEND imapsieve_mailbox3_before = file:/usr/local/lib/dovecot/sieve/report-ham.sieve sieve_pipe_bin_dir = /usr/local/lib/dovecot/sieve } Maintenant que Dovecot est pr√™t, on pr√©pare la partie Sieve qui d√©pend de deux scripts pour entra√Æner le Spam et le Ham dans /usr/local/lib/dovecot/sieve :\n# cat report-ham.sieve require [\u0026#34;vnd.dovecot.pipe\u0026#34;, \u0026#34;copy\u0026#34;, \u0026#34;imapsieve\u0026#34;, \u0026#34;environment\u0026#34;, \u0026#34;variables\u0026#34;]; if environment :matches \u0026#34;imap.mailbox\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;mailbox\u0026#34; \u0026#34;${1}\u0026#34;; } if string \u0026#34;${mailbox}\u0026#34; \u0026#34;Trash\u0026#34; { stop; } if environment :matches \u0026#34;imap.user\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;username\u0026#34; \u0026#34;${1}\u0026#34;; } pipe :copy \u0026#34;sa-learn-ham.sh\u0026#34; [ \u0026#34;${username}\u0026#34; ]; # cat report-spam.sieve require [\u0026#34;vnd.dovecot.pipe\u0026#34;, \u0026#34;copy\u0026#34;, \u0026#34;imapsieve\u0026#34;, \u0026#34;environment\u0026#34;, \u0026#34;variables\u0026#34;]; if environment :matches \u0026#34;imap.user\u0026#34; \u0026#34;*\u0026#34; { set \u0026#34;username\u0026#34; \u0026#34;${1}\u0026#34;; } pipe :copy \u0026#34;sa-learn-spam.sh\u0026#34; [ \u0026#34;${username}\u0026#34; ]; Et parce que les deux scripts Sieve d√©pendent de scripts shell sa-learn-ham.sh et sa-learn-spam.sh, on cr√©e aussi ces deux scripts shell dans /usr/local/lib/dovecot/sieve :\n# cat sa-learn-ham.sh #!/bin/sh exec /usr/local/bin/rspamc -d \u0026#34;${1}\u0026#34; learn_ham # cat sa-learn-spam.sh #!/bin/sh exec /usr/local/bin/rspamc -d \u0026#34;${1}\u0026#34; learn_spam Enfin, on compile les scripts Sieve et on rend les scripts shell ex√©cutables pour que Dovecot puisse les utiliser :\n# sievec report-ham.sieve # sievec report-spam.sieve # chmod 755 sa-learn-ham.sh # chmod 755 sa-learn-spam.sh C\u0026rsquo;est tout. Dor√©navant en d√©pla√ßant un mail d\u0026rsquo;un r√©pertoire √† un autre, on doit voir les lignes suivantes dans le fichier de log /var/log/rspamd/rspamd.log :\n2019-09-13 23:59:46 #18598(controller) \u0026lt;1d44bd\u0026gt;; csession; rspamd_controller_learn_fin_task: \u0026lt;127.0.0.1\u0026gt; learned message as ham: CAHPtQbOxQxBCsVd7nUCP4podu74Pa-F6k28z+4BWfNeeqWYiAg@mail.gmail.com [‚Ä¶] 2019-09-14 00:01:57 #18598(controller) \u0026lt;b76e28\u0026gt;; csession; rspamd_controller_learn_fin_task: \u0026lt;127.0.0.1\u0026gt; learned message as spam: CAHPtQbOxQxBCsVd7nUCP4podu74Pa-F6k28z+4BWfNeeqWYiAg@mail.gmail.com [‚Ä¶] Il est surement possible de simplifier, je vais √™tre honn√™te et dire que mon int√©r√™t pour Sieve n\u0026rsquo;est pas assez pouss√© pour que je me perfectionne. C\u0026rsquo;est une fonctionnalit√© sur le c√¥t√© et je ne toucherai probablement pas les scripts avant les dix prochaines ann√©es. Je ne suis pas du tout convaincu par Sieve et quand j\u0026rsquo;aurai le temps, je ferais une alternative qui ne me rappelle pas les ann√©es m4 de Sendmail.\nTester le tout # Et maintenant, on va juste tester que l\u0026rsquo;on arrive √† faire un trajet complet aller-retour de mail depuis hypno.cat vers gmail.com.\nTout d\u0026rsquo;abord, je pr√©pare un mail depuis mon compte hypno.cat vers mon compte gmail.com :\nApr√®s envoi, je v√©rifie qu\u0026rsquo;il arrive bien chez gmail.com :\nEnsuite, je v√©rifie que l\u0026rsquo;√©mission a bien eu lieu par dessus un canal s√©curis√© par TLS :\nJe v√©rifie √©galement que gmail.com est content avec notre d√©claration SPF, notre signature DKIM et qu\u0026rsquo;il a bien vu notre enregistrement DMARC. On fait cela en s√©lectionnant \u0026ldquo;Voir l\u0026rsquo;original\u0026rdquo; dans le menu associ√© √† chaque mail :\nEnfin, j\u0026rsquo;y r√©pond pour √™tre sur que √ßa fonctionne dans les deux sens :\nCool, on a fini # Cet article est dense, je voulais expliquer pourquoi on fait les choses. Si vous retirez toutes les explications et gardez juste les d√©tails purement techniques, vous r√©aliserez que nous avons construit une infrastructure de mail, fournissant des services entrants et sortants s√©curis√©s par TLS, avec un trafic sortant respectant DKIM, SPF et DMARC, et un trafic entrant filtrant le spam.\nOn a fait cela en :\najoutant deux enregistrements A, un MX et trois TXT dans notre zone DNS; faisant attention √† avoir un rDNS correctement configur√© installant un certificat TLS pr√©parant un fichier de configuration d\u0026rsquo;environ 15 lignes pour un serveur SMTP modifiant 3 lignes dans la configuration par d√©faut d\u0026rsquo;un serveur IMAP modifiant 8 lignes dans la configuration par d√©faut d\u0026rsquo;une solution antispam Et parce que nous √©tions de tres bonne humeur et volontaires pour faire un petit pas de plus, nous avons impl√©ment√© un apprentissage Spam / Ham de Rspamd en :\nmodifiant environ 20 lignes dans la configuration par d√©faut d\u0026rsquo;un serveur IMAP copiant 4 scripts Sieve dans un r√©pertoire On admettra qu\u0026rsquo;un nouvel arrivant va devoir fournir quelques efforts pour trouver tout √ßa sans aide, mais aucune de ces t√¢ches n\u0026rsquo;est r√©ellement difficile ou complexe. De plus, la plupart sont des op√©rations de mises en place qui ne sont r√©alis√©es qu\u0026rsquo;une fois ; on n\u0026rsquo;√©dite pas la zone DNS ou un reverse DNS tous les deux jours, tout comme on ne touche pas une configuration en place qui fonctionne tant qu\u0026rsquo;il n\u0026rsquo;y a pas de nouveau cas d\u0026rsquo;utilisation.\nPour citer les plus r√©fractaires √† l\u0026rsquo;auto-h√©bergement, il peut y avoir des maintenances pour g√©rer les cons√©quences d\u0026rsquo;une blacklist, mais il n\u0026rsquo;y a aucun sc√©nario dans lequel ladite maintenance impliquerait autant de travail que la mise en place que nous venons de faire‚Ä¶ et qui au final se r√©plique en 10 minutes chrono une fois r√©alis√©e une premi√®re fois pour se faire la main.\nQuelle est la prochaine √©tape ? # Votre prochaine √©tape est de mettre en place de la redondance pour vous assurer qu\u0026rsquo;une panne de votre serveur de mail n\u0026rsquo;entraine pas de perte de mail.\nEn pratique, la plupart des serveurs de mails retentent une √©mission de multiples fois si la destination est inaccessible donc, m√™me en cas de panne, la plupart de vos mails seront temporis√©s par votre √©metteur et retransmis quand votre serveur sera de nouveau accessible.\nEn th√©orie, on veut tout de m√™me faire les choses bien, et reposer sur la responsabilit√© des autres √† g√©rer nos pannes n\u0026rsquo;est pas tr√®s poli. Vous devez mettre en place un serveur secondaire, vous arranger entre amis pour √™tre serveurs secondaires les uns des autres, ou m√™me vous souscrire √† un service qui offre du mail secondaire. N\u0026rsquo;importe quoi qui puisse permettre de couvrir vos arri√®res lorsque votre serveur primaire tombe.\nEnsuite, peu importe la m√©thode choisie, il vous faudra :\najouter un enregistrement MX suppl√©mentaire dans votre zone DNS configurer le serveur secondaire pour retransmettre les mails au serveur primaire On est loin de la haute voltige.\nEst-ce qu\u0026rsquo;on a vraiment fini ? # Je vais probablement √©crire une s√©rie d\u0026rsquo;article pour discuter de la r√©putation, ainsi que des m√©canismes en place chez les Big Mailer Corps qui provoquent des pannes de distribution.\nSi ce sont des sujets d\u0026rsquo;int√©r√™t et que j\u0026rsquo;ai du feedback positif, j\u0026rsquo;√©crirais plus souvent sur les concepts autour de la d√©liverabilit√©, sinon je reprendrais mes anciennes activit√©s : √©crire mes rapports mensuels sur mes contributions opensource. √Ä vous de me dire :-)\nFinalement, dans cet article j\u0026rsquo;ai d√©crit un setup vraiment simple mais il y a des tonnes de choses int√©ressantes √† faire avec les infrastructures de mail, si vous n\u0026rsquo;avez pas peur d\u0026rsquo;aller plus loin.\nJe construis actuellement une infrastructure de mail pour un future service commercial d\u0026rsquo;h√©bergement. L\u0026rsquo;infrastructure s\u0026rsquo;√©tend sur plusieurs data centers dans plusieurs pays, a des serveurs secondaires capable d\u0026rsquo;encaisser des pannes tr√®s s√©rieuses des serveurs primaires, peut facilement monter √† l\u0026rsquo;√©chelle sur des pics de volume, elle d√©corelle le trafic entrant et sortant pour permettre de fournir des services partiels, peut facilement re-router le trafic entre des machines pour contourner des pannes, tout en fournissant des services IMAP √† des comptes virtuels sur une multitude de domaines, avec des backups quotidiens. L\u0026rsquo;infrastructure me coute‚Ä¶ moins de 75 EUR par mois. Elle est √©galement tr√®s simple, la plupart des machines sont des installations par d√©faut d\u0026rsquo;OpenBSD avec tr√®s peu de changements au syst√®me de base.\nSi lire √† propos de ce genre de mises en place vous int√©resse, je peux √©crire √† ce sujet pour aider un maximum de personnes √† monter un maximum d\u0026rsquo;alternatives aux Big Mailer Corps, ce qui est au final mon souhait.\nMerci de m\u0026rsquo;avoir lu, je n\u0026rsquo;ai pas de soundcloud, mais j\u0026rsquo;ai un patreon et un github si vous voulez me sponsoriser, ou utiliser les icones en dessous du lien de commentaires pour partager cet article sur les reseaux sociaux.\n","date":"23 Janvier 2019","permalink":"/fr/posts/2019-12-23/mettre-en-place-un-serveur-de-mail-avec-opensmtpd-dovecot-et-rspamd/","section":"Posts","summary":"TL;DR: - Pas de r√©sum√©, j'ai pass√© des heures √† traduire, vous allez passer des minutes √† lire ;) - OK‚Ä¶ J'ai expliqu√© avec BIEN TROP DE D√âTAILS comment mettre en place un serveur de mail Merci √† mes sponsors !","title":"Mettre en place un serveur de mail avec OpenSMTPD, Dovecot et Rspamd"},{"content":" TL;DR: - SMTP est la m√©thode dont les ordinateurs √©changent des e-mails - il s'agit d'un protocole d√©centralis√©, ce qui signifie que CHACUN peut h√©berger un n≈ìud et √™tre ind√©pendant - il est en train d'√™tre centralis√© dans des soci√©t√©s qui ont un passif d'abus - il est en train d'√™tre centralis√© dans un pays qui a un passif d'abus O√π est-ce que j\u0026rsquo;ai d√©j√† lu √ßa ? # En Ao√ªt, j\u0026rsquo;ai publi√© un petit article intitul√© \u0026ldquo; You should not run your mail server because mail is hard\u0026rdquo; (\u0026ldquo;Vous ne devriez pas h√©berger votre serveur de mail parce que c\u0026rsquo;est dur\u0026rdquo;) qui √©tait, en gros, mon opinion sur les diff√©rentes raisons qui poussent les gens √† d√©courager l\u0026rsquo;h√©bergement de mails. De mani√®re tr√®s inattendue, l\u0026rsquo;article est devenu assez populaire, atteignant 100K lectures et continuant √† recevoir des visites et des commentaires plusieurs mois apr√®s publication.\nEn Septembre, j\u0026rsquo;ai publi√© un autre article beaucoup plus long intitul√© \u0026ldquo; Setting up a mail server with OpenSMTPD, Dovecot and Rspamd\u0026rdquo; (\u0026ldquo;Installer un serveur de mail avec OpenSMTPD, Dovecot et Rspamd\u0026rdquo;) qui d√©crivait pas √† pas, de fa√ßon tr√®s d√©taill√©e, les √©tapes pour installer un serveur de mail complet jusqu\u0026rsquo;√† la livraison des e-mails en bo√Æte de r√©ception chez un gros h√©bergeur de mail am√©ricain. L\u0026rsquo;article est devenu lui aussi plut√¥t populaire, sans pour autant atteindre le niveau du pr√©cedent article moins technique et sp√©cifique, mais atteignant 40K lectures et continuant √©galement √† recevoir des visites et des commentaires plusieurs mois apr√®s publication.\nLe contenu que vous vous appr√™tez √† lire est extrait de ce second article auquel il n\u0026rsquo;aurait pas d√ª √™tre rattach√©. Il est bien trop (g√©o-)politique pour faire partie d\u0026rsquo;un article technique, j\u0026rsquo;ai donc d√©cid√© de l\u0026rsquo;en retirer et d\u0026rsquo;en faire un d√©di√©. Je ne veux pas que les sp√©cificit√©s d\u0026rsquo;un article sur OpenSMTPD aille √† l\u0026rsquo;encontre d\u0026rsquo;un message beaucoup plus g√©n√©ral.\nC\u0026rsquo;est mon premier article en fran√ßais depuis des ann√©es, je vous demande donc un peu d\u0026rsquo;indulgence : si vous trouvez des fautes, vous pouvez me les remonter pour que je les corrige, ou faire une pull request pour les techies.\nN\u0026rsquo;h√©sitez pas √† partager la publication √† l\u0026rsquo;aide des icones en fin d\u0026rsquo;article et √† la commenter \u0026lt;3\nQui sont Big Mailer Corps ? # Je ne vais pas pointer de doigts vers des directions en particulier. Concr√®tement, rentrent dans ma d√©finition des Big Mailer Corps, toute grosse entreprise qui centralise l\u0026rsquo;h√©bergement des e-mails d\u0026rsquo;un tr√®s grand nombre d\u0026rsquo;utilisateurs :\n- Orange ? SFR ? La Poste ? - Non, plus grand, plus mondial, ‚Ä¶ Et l√†, normalement le doute est dissip√©, pas besoin de citer de nom. Vous avez compris qui est vis√© parce que TOUT LE MONDE connait les Big Mailer Corps, la plupart d\u0026rsquo;entre vous avez une adresse chez l\u0026rsquo;un d\u0026rsquo;entre eux, et la plupart de vos contacts sont h√©berg√©s chez l\u0026rsquo;un d\u0026rsquo;entre eux.\nL\u0026rsquo;auto-h√©bergement et encourager les petits fournisseurs est meilleur pour notre bien commun # Il y a des cons√©quences √† la centralisation des services de mail chez les Big Mailer Corps.\nIl n\u0026rsquo;y a aucun sens √† ce que Jacques Lambda, qui partage des photos de chatons avec sa famille et ses amis, se construise une infrastructure d\u0026rsquo;h√©bergement de mails alors que plusieurs Big Mailer Corps lui offrent, \u0026ldquo;gratuitement\u0026rdquo;, une qualit√© de service au top. Il peut obtenir une adresse e-mail imm√©diatement disponible et qui marche de mani√®re parfaitement fiable. Il n\u0026rsquo;y a absolument aucun sens √† ce que Jacques Lambda n\u0026rsquo;aille pas chez l\u0026rsquo;un des Big Mailer Corps, particuli√®rement quand m√™me les techies font ce choix sans h√©sitation, confirmant que c\u0026rsquo;est plut√¥t une bonne option.\nIl n\u0026rsquo;y a rien de mal √† ce que tous les Jacques Lambda choisissent un service qui marche.\nCe qui est terriblement mauvais par contre, c\u0026rsquo;est le centralisation d\u0026rsquo;un protocole de communication dans les mains d\u0026rsquo;une poign√©e d\u0026rsquo;entreprises commerciales, CHACUNE D\u0026rsquo;ENTRE ELLES provenant du m√™me pays (actuellement dirig√© par un lunatique qui abuse de son pouvoir et souffre probablement de trouble de la personnalit√© narcissique), CHACUNE D\u0026rsquo;ENTRE ELLES √©tant apparu dans les informations et/ou dans une cour de tribunal pour tout un assortiment de comportements \u0026ldquo;d√©plaisants\u0026rdquo; (abus de la vie priv√©e, espionnage, abus de monopole, harcellement professionnel ou sexuel, j\u0026rsquo;en passe‚Ä¶ ), et CHACUNE D\u0026rsquo;ENTRE ELLES faisant cro√Ætre des bases d\u0026rsquo;utilisateurs qui d√©passent de loin la population totale de plusieurs pays combin√©s.\nMettons un peu de perspective. Le plus gros des Big Mailer Corps annonce une base d\u0026rsquo;utilisateur qui d√©passe 1.4 MILLARD d\u0026rsquo;utilisateurs (Avril 2018), soit √† peu pr√®s la population totale de la Chine ou de l\u0026rsquo;Inde, plus de quatre fois la population totale des USA, ou plus de vingt fois la population totale de la France. Si vous comptiez les utilisateurs au rythme d\u0026rsquo;un par seconde, il vous faudrait 44 ans pour en faire le tour.\nEnsuite, tr√®s loin derri√®re, il est suivi par le prochain Big Mailer Corp qui annonce une base de 400 millions d\u0026rsquo;utilisateurs (2018 √©galement), d√©passant la population totale des USA, atteignant quatre fois la population totale de l\u0026rsquo;√âgypte, et cinq fois la population totale de la France.\nDans la plupart des rapports de mailing que j\u0026rsquo;ai pu surveiller, le premier des Big Mailer Corps couvre approximativement la moiti√© des adresse e-mails de destinataires‚Ä¶ l\u0026rsquo;autre moiti√© √©tant √©galement couverte en large partie par les autres Big Mailer Corps.\nCe n\u0026rsquo;est pas sain. Ni ici, ni nulle part, ni maintenant, ni jamais, ni dans aucune dimension alternative (ins√©rer \u0026ldquo;sliiiiiiders\u0026rdquo; en chuchotement mental ici).\nPrenez un moment pour bien enregistrer ce qui suit :\nSi ces grosses entreprises √©taient contraintes de couper les communications avec un pays pour appliquer des sanctions, bien au del√† d\u0026rsquo;un MILLIARD de personnes seraient hors de port√©e pour le pays vis√©. Et si vous pensez la crainte exag√©r√©e, les utilisateurs de Github en Iran, en Syrie, √† Cuba ou en Crim√©e pourraient vous donner un point de vue diff√©rent apr√®s avoir d√©couvert qu\u0026rsquo;ils √©taient mis √† la porte pour appliquer les sanctions am√©ricaines sur leurs pays.\nAussi ennuyant soit-il, Git reste un outil de techies qui n\u0026rsquo;impacte principalement que des techies, une minorit√© d\u0026rsquo;humains qui sait trouver facilement des solutions de contournement‚Ä¶ facilit√©es par le fait que Git est d√©centralis√© et ne n√©cessite pas d\u0026rsquo;interconnexions et d\u0026rsquo;interop√©rabilit√© : les utilisateurs peuvent facilement bouger ailleurs et s\u0026rsquo;auto-h√©berger. Aucun lien coup√© avec aucun pays ne peut emp√™cher √ßa.\nLe mail fonctionne de fa√ßon diff√©rente. Il impacte tout le monde, des personnes de tous √¢ges et qui ne sont pas forc√©ment des techies. Il est toujours possible de trouver une solution de contournement en cas de blocage, mais ce n\u0026rsquo;est pas simple pour tout le monde. Et comme il s\u0026rsquo;agit d\u0026rsquo;un protocole pour mettre en relation un √©metteur A avec un destinataire B, il y a un besoin d\u0026rsquo;interconnexion, un besoin d\u0026rsquo;interop√©rabilit√© ET besoin que le lien entre A et B ne soit pas coup√©. Les cons√©quences d\u0026rsquo;un blocage similaire √† celui de Github chez les Big Mailer Corps seraient plusieurs ordres de magnitude plus durs et visibles : un pan des utilisateurs d\u0026rsquo;Internet ne serait tout bonnement plus joignable par les citoyens des pays sanctionn√©s.\nLes habitants des pays de merde ne sont pas tous des techies, ils sont des personnes qui ont BESOIN d\u0026rsquo;interconnexions et d\u0026rsquo;interop√©rabilit√© pour communiquer avec plus d\u0026rsquo;un MILLIARD de personnes h√©berg√©es chez les Big Mailer Corps. Le mail permet de connecter les populations mondiales de mani√®re fiable‚Ä¶ UNIQUEMENT si le mail reste d√©centralis√©. Il ne marche plus s\u0026rsquo;il est centralis√© dans une poign√©e d\u0026rsquo;entreprises toutes localis√©es dans le m√™me pays.\nBien s√ªr cela n\u0026rsquo;arrivera peut √™tre jamais, et je metterai m√™me mon billet dessus parce qu' un pays connu pour avoir intercept√© et √©pi√© les communications mondiales a plus d\u0026rsquo;int√©r√™t √† conserver le flot des communications qu\u0026rsquo;√† le couper, mais le seul fait que ce soit TECHNIQUEMENT possible devrait √™tre suffisant pour nous mettre mal √† l\u0026rsquo;aise. J\u0026rsquo;ignore m√™me volontairement que la raison pour laquelle ils ne le feront pas me rends √©galement mal √† l\u0026rsquo;aise. Si les Big Mailer Corps √©taient h√©berg√©s en Chine, nous serions d√©j√† en train d\u0026rsquo;envisager les cons√©quences d\u0026rsquo;une coupure et d\u0026rsquo;envisager un plan de sortie, mais nous ne le faisons pas parce que nous pensons que nous sommes du bon c√¥t√© de la barri√®re, et que des sanctions √† notre encontre ne pourraient pas arriver.\nMais √ßa, c\u0026rsquo;est jusqu\u0026rsquo;√† ce que l\u0026rsquo;on soit compl√®tement au pied du mur sans solution.\n√Ä ce stade, je pourrais √©galement faire semblant d\u0026rsquo;ignorer que le mod√®le √©conomique de la plupart de certaines de ces entreprises repose sur la cr√©ation d\u0026rsquo;un profil commercial de leurs utilisateurs et qu\u0026rsquo;avoir √† disposition tous les e-mails est une mine d\u0026rsquo;or.\nCertains Big Mailer Corps se d√©fendent d\u0026rsquo;exploiter le contenu des e-mails, mais‚Ä¶ il n\u0026rsquo;y a pas besoin de conna√Ætre le contenu des e-mails si les exp√©diteurs et destinataires sont √©crits sur l\u0026rsquo;enveloppe. Il est tout √† fait possible de savoir que vous essayer de souscrire un cr√©dit en faisant des comparatifs, mais que vous recevez √©galement des remboursements de sant√© r√©guliers et que vous recevez des informations concernant un certain type d\u0026rsquo;appareillage m√©dical. Un profil tr√®s pr√©cis et qui serait tr√®s int√©ressant pour des organismes de pr√™t ou des assurances peut tout √† fait √™tre dress√© sans avoir √† \u0026ldquo;lire\u0026rdquo; les e-mails‚Ä¶ mais bon, ce ne sont que des sp√©culations bas√©es sur quelque chose de techniquement r√©alisable.\nDans la m√™me id√©e, je vais faire semblant d\u0026rsquo;ignorer que tous les documents partag√©s peuvent √™tre analys√©s pour d√©tecter des logiciels malveillants, que le document soit confidentiel ou non, qu\u0026rsquo;il soit strat√©gique ou non. Tout comme les liens √©chang√©s par mail, qu\u0026rsquo;ils soient strat√©giques ou non, perdent tout caract√®re confidentiel lorsqu\u0026rsquo;ils passent par le webmail d\u0026rsquo;un Big Mailer Corp.\nAlors OUI, il faut plus de personnes qui s\u0026rsquo;auto-h√©bergent ou qui d√©pendent d\u0026rsquo;h√©bergeurs g√©olocalis√©s, tissant un r√©seau de communication le plus vaste au-travers de plusieurs op√©rateurs dans plusieurs pays. Je ne pense √©videmment pas que tout le monde doit s\u0026rsquo;auto-h√©berger, mais je pense que DAVANTAGE de monde doit sortir des Big Mailer Corps pour aller n\u0026rsquo;importe o√π ailleurs‚Ä¶ il faut r√©introduire de la contrainte chez les les Big Mailer Corps, qu\u0026rsquo;ils soient oblig√©s d\u0026rsquo;interagir avec des op√©rateurs en dehors de leur gang, et qu\u0026rsquo;il y ait un risque financier SI soudainement ils prenaient des d√©cisions √† l\u0026rsquo;encontre des populations.\nLes Big Mailer Corps ne sont pas mauvais ou m√©chants, j\u0026rsquo;utilise moi-m√™me leurs services r√©guli√®rement, et la plupart de leurs employ√©s cherchent probablement le bien commun‚Ä¶ mais ces entreprises sont devenues trop grosses et puissantes, il faut qu\u0026rsquo;il y ait un √©quilibre parce que l\u0026rsquo;on ne sait pas comment elles √©volueront dans les ann√©es √† venir, on ne sait pas non plus comment √©voluera la politique de leurs pays d\u0026rsquo;origine dans les ann√©es √† venir, et les informations r√©centes ne d√©crivent pas un avenir tout rose dans la bonne direction.\nJe concluerai en vous recommandant de regarder cette excellente pr√©sentation de Bert Hubert ( @PowerDNS_Bert) de PowerDNS, √† propos de probl√®mes similaires qui sont en train d\u0026rsquo;√©merger avec le protocole DNS et les craintes qui en d√©coulent autour de la surveillance. De tr√®s nombreux points de sa pr√©sentation sont tout aussi valides en ce qui concerne les services de mail.\n","date":"15 Janvier 2019","permalink":"/fr/posts/2019-12-15/decentralisons-smtp-pour-le-bien-commun/","section":"Posts","summary":"TL;DR: - SMTP est la m√©thode dont les ordinateurs √©changent des e-mails - il s'agit d'un protocole d√©centralis√©, ce qui signifie que CHACUN peut h√©berger un n≈ìud et √™tre ind√©pendant - il est en train d'√™tre centralis√© dans des soci√©t√©s qui ont un passif d'abus - il est en train d'√™tre centralis√© dans un pays qui a un passif d'abus O√π est-ce que j\u0026rsquo;ai d√©j√† lu √ßa ?","title":"D√©centralisons SMTP pour le bien commun"},{"content":" TL;DR: Le mail n\u0026rsquo;est pas dur: les gens r√©p√®tent √ßa parce qu\u0026rsquo;ils l\u0026rsquo;ont lu, pas parce qu\u0026rsquo;ils ont essay√© Les Big Mailer Corps sont content de ce mythe, √ßa fait grossir leur base d\u0026rsquo;utilisateurs Les Big Mailer Corps contr√¥lent un large pourcentage de l\u0026rsquo;espace d\u0026rsquo;adressage des e-mails ce qui n\u0026rsquo;est bon pour personne C\u0026rsquo;est ok que des gens aient leurs adresses e-mails h√©berg√©s chez des Big Mailer Corps tant qu\u0026rsquo;il y a assez de gens en dehors EDIT (2019-12-15) # Un guide practice pour installer un serveur de mail a √©t√© publi√© sur ce blog.\nAvertissement # CECI EST POUR LES SYSADMINS AVEC UNE COMPR√âHENSION TECH ET QUI SAVENT H√âBERGER DES SERVICES. L\u0026rsquo;auto-h√©bergement n\u0026rsquo;est pas DUR mais requiert du TRAVAIL, deux choss diff√©rentes. Mettre en place une infrastructure de mail demande beaucoup de travail en amont, puis de la maintenance tr√®s basqie sur le long terme.\nJe travaille sur un serveur SMTP open source. Je construit des solutions open source et propri√©taires li√©es au mail.\nDans cet article, je vais volontairement utiliser le terme mail parce qu\u0026rsquo;il est assez vague pour englober protocoles et logiciels. Ce n\u0026rsquo;est pas un article tr√®s technique et je ne veux pas plonger dans les d√©tails, je veux que les gens qui n\u0026rsquo;ont jamais travaill√© avec le mail puisse tout comprendre.\nJe ne vais pas non plus expliquer comment j\u0026rsquo;accomplis les t√¢ches que je d√©cris comme simples. Je veux que cet article se concentre sur le mythe \u0026ldquo;le mail est dur\u0026rdquo;, mettant de c√¥t√© les solutions techniques utilis√©es pour les impl√©menter. Je veux que les personnes qui lisent ceci puisse se renseigner sur Postfix, Notqmail, Exim et OpenSMTPD, et pas simplement aller directement sur OpenSMTPD parce que j\u0026rsquo;aurais donn√© des exemples.\nJ\u0026rsquo;√©crirais ensuite un article pour y faire suite, cette fois-ci en montrant comment je fais les choses avec OpenSMTPD. Si des personnes √©crivent des articles similaires pour d\u0026rsquo;autres solutions, transmettez-les moi et j\u0026rsquo;en linkerai quelques uns. Cet article sera mis √† jour de temps en temps au fil des changements, revenez de temps √† autre.\nEnfin, Le nom Big Mailer Corps repr√©sente les fournisseurs d\u0026rsquo;e-mails principaux. Je me veux pas en viser un sp√©cifique, vous pouvez concr√®tement remplacer Big Mailer Corps n\u0026rsquo;importe o√π dans ce texte par le nom d\u0026rsquo;un fournisseur qui d√©tient plusieurs centaines de millions d\u0026rsquo;adresse de destinataires. Gardez aussi √† l\u0026rsquo;esprit que certains Big Mailer Corps permettent d\u0026rsquo;h√©berger sous votre propre nom de domaine, donc quand je parle d\u0026rsquo;espace d\u0026rsquo;adressage e-mail, si vous poss√©dez un domain mais qu\u0026rsquo;il est host√© par un Big Mailer Corp, alors votre domaine et vos adresses font partie de leur espace d\u0026rsquo;adressage.\nIl √©tait une fois, \u0026ldquo;le mail est dur\u0026rdquo; # Lorsque vous commencez √† cherchez √† devenir ind√©pendant pour vos e-mails, d√®s lors que vous demandez de l\u0026rsquo;aide pour \u0026ldquo;monter un serveur de mail\u0026rdquo; sur un media tech, les gens vont invariablement sauter dans la discussion pour vous d√©courager d\u0026rsquo;essayer parce que \u0026ldquo;le mail est dur\u0026rdquo;.\nNon seulement \u0026ldquo;le mail est dur\u0026rdquo; mais il semblerai aussi que \u0026ldquo;les Big Mailer Corps ont d√©j√† gagn√©s\u0026rdquo;, que \u0026ldquo;tous les mails que vous enverrez √† vos destinataires vont terminer en boite √† spam\u0026rdquo;, et que \u0026ldquo;vous serez inond√©s de spammers\u0026rdquo; qui vont \u0026ldquo;abuser de votre serveur pour lui faire relayer du spam au monde\u0026rdquo;.\nWow, √ßa fait beaucoup l√† non ? :-|\nVous vouliez juste envoyer et recevoir du mail parce que √ßa semblai une bonne id√©e, et c\u0026rsquo;est devenu la pire des d√©cisions de votre vie. Mais est-ce que √ßa l\u0026rsquo;est vraiment ?\nLe logiciel est difficile # Le mail √©tait dur\u0026hellip; Il y a longtemps, tr√®s longtemps.\nIl √©tait dur parce que les logiciels √©taient durs √† configurer correctement. Un serveur de mail comme Sendmail demandait au moins un doctorat en th√©orie des langages pour se configurer, et la culture √©litiste des postmasters qui pouvaient lire les \u0026ldquo;fichiers de configuration\u0026rdquo; de Sendmail n\u0026rsquo;a pas aid√© √† cr√©er un environnement tr√®s amical pour les d√©butants. Les postmasters se plaignaient de la complexit√© de Sendmail, tout en d√©clarant leur amour inconditionnel pour le format m4 dans un concours de la plus grosse. Je peux facilement imaginer ces gens se fouetter avec des orties fraiches par hobby.\nPostfix est une alternative √† Sendmail qui est pr√©sente depuis 1998. Je ne la consid√®rerai pas comme \u0026ldquo;simple\u0026rdquo; m√™me en √©tant tr√®s imaginatif, mais elle est des ordres de magnitude plus simple que Sendmail. Avec l\u0026rsquo;aide d\u0026rsquo;un moteur de recherche, les d√©butants peuvent facilement trouver des tutoriels et identifier les trois ou quatre options de configurations √† modifier.\nOpenSMTPD est une autre alternative publi√©e pour la premi√®re en 2013. Elle est √©galement des ordres de magnitude plus simple que Sendmail. La configuration se lit presque en anglais et un fichier de configuration utilisable peut tenir \u0026hellip; dans un tweet.\n[full screen](/images/2019-08-30-tweet.png) Je n\u0026rsquo;ai pas d\u0026rsquo;exp√©rience avec les autres, mais la plupart des syst√®mes d\u0026rsquo;expoloitation et des distributions fournissent plusieurs alternatives, pr√©-packag√©es pour pouvoir √™tre installi√©es en une seule commande.\nLes logiciels de mail ne sont pas durs. Ils ne le sont que si vous avez arr√™t√© de regarder dans les ann√©es 90.\nOK, les logiciels ne sont pas dur mais g√©rer le SPAM si # Le mythe continue en annon√ßant que le mail est difficile parce que d√®s lors que l\u0026rsquo;on fait tourner son propre serveur de mail, les spammers d√©barquent en hordes et que g√©rer le spam devient un cauchemar quotidien. √áa ne pourrait pas √™tre plus √©loign√© de la r√©alit√©.\nMaintenant qu\u0026rsquo;on se connait un peu et que nous avons √©tabli un peu de confiance, je ne vais pas vous mentir: il y a des hordes de spammers.\nLorsque vous branchez votre serveur sur internet, vous allez voir des connections al√©atoires de diff√©rentes sources essayer de faire passer du mail √† travers votre serveur. Vous les verrez venir depuis des connections domestiques, depuis des pays lointains, depuis des adresses IP qui partagent la m√™me plage IP, il n\u0026rsquo;y aura pas de fin √† l\u0026rsquo;√©merveillement que cela pourra vous procurer.\nMais concr√®tement, elles entreront dans deux cat√©gories:\ndes clients qui essaient d\u0026rsquo;abuser votre serveur pour s\u0026rsquo;en servir en relai et spammer le monde des clients qui essaient de vous spammer vous apr√®s avoir obtenir votre adresse e-mail d\u0026rsquo;une certaine fa√ßon Ceux de la premi√®re cat√©gorie sont les plus simple √† g√©rer: IGNOREZ LES. Ils cherchent des serveurs mal configur√©s et tentent des choses qui sont rejet√©es par un serveur correctement configur√©, o√π tentent de s\u0026rsquo;authentifier avec des attaques par dictionnaire qui sont garanties d\u0026rsquo;√©chouer si vous avez une politique de bons mots de passes. Ce sont les √©quivalents des moustiques un soir d\u0026rsquo;√©t√©, ils sont ennuyeux mais\u0026hellip; mouais.\nc1a89cb774083905 smtp connected address=185.234.219.64 host=\u0026lt;unknown\u0026gt; c1a89cb774083905 smtp failed-command command=\u0026#34;AUTH LOGIN\u0026#34; result=\u0026#34;503 5.5.1 Invalid command: Command not supported\u0026#34; c1a89cb774083905 smtp disconnected reason=disconnect c1a89cb8c5b84cbf smtp connected address=193.32.160.143 host=\u0026lt;unknown\u0026gt; c1a89cb8c5b84cbf smtp bad-input result=\u0026#34;500 5.5.1 Invalid command: Pipelining not supported\u0026#34; c1a89cb8c5b84cbf smtp disconnected reason=quit c1a89cb9441966e7 smtp connected address=185.234.219.193 host=\u0026lt;unknown\u0026gt; c1a89cb9441966e7 smtp failed-command command=\u0026#34;AUTH LOGIN\u0026#34; result=\u0026#34;503 5.5.1 Invalid command: Command not supported\u0026#34; c1a89cb9441966e7 smtp disconnected reason=disconnect Si vraiment, vraiment ils vous embettent ou que vous ne supportiez pas de voir ces tentatives √©chou√©es dans vos logs, √©crivez un script qui d√©tecte ces motifs dans les logs et ajoute les clients ind√©licats dans vos r√®gles de firewall. Par pure flemme, je n\u0026rsquo;ai jamais utilis√© de scripts comme cela en vingt ans d\u0026rsquo;h√©bergement de serveurs de mails et\u0026hellip; je suis encore l√† pour vous en parler. Tant que vous les voyez pas tenter quelque chose de surprenant, contentez vous de les ignorer.\nCeux de la seconde cat√©gorie sont un peu plus ennuyants parce que si vous les ignorez, votre boite mail se retrouve pleine de spam. Heureusement, ils ne sont pas si durs que cela √† filtrer au travers de plusieurs m√©thodes simples et il est tr√®s facile de r√©duire le spam √† quelques mails, de temps √† autre, le plus souvent class√©s dans la boite √† Spam. Je ne prends absolument aucune pr√©caution pour cacher mon adresse e-mail, gilles@poolp.org, et j\u0026rsquo;ai de temps en temps quelques spams qui arrivent dans ma boite a spam. Non seulement ce n\u0026rsquo;est pas un cauchemar quotidien, mais c\u0026rsquo;est en r√©alit√© moins que ce que je re√ßois sur mon compte Big Mailer Corp\u0026hellip; que je ne communique pas autant et qui a pourtant entre trois et cinq fois la quantit√© quotidienne de spam.\nNotez que certains filtres tr√®s simples que vous pouvez appliquer pour la seconde cat√©gorie de spammers et aussi TR√àS efficace pour tuer la premi√®re cat√©gorie:\na56dece24dcac3d2 smtp failed-command command=\u0026#34;DATA\u0026#34; result=\u0026#34;550 message rejected\u0026#34; a56ded3dd6cda8c2 smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;550 your IP reputation is too low for this MX\u0026#34; a56ded3f7db5b96c smtp failed-command command=\u0026#34;DATA\u0026#34; result=\u0026#34;550 message rejected\u0026#34; a56dec6ffdb2caef smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;421 you must have rDNS to contact this MX\u0026#34; a56dec895475b9bf smtp failed-command command=\u0026#34;\u0026#34; result=\u0026#34;421 you must have FCrDNS to contact this MX\u0026#34; Je vais le dire une bonne fois pour toute: Vous n\u0026rsquo;atteindrez jamais le 0 absolu en spam, √ßa a d√©j√† √©t√© prouv√© dans les ann√©es 2000s (je n\u0026rsquo;ai plus la r√©f√©rence, d√©sol√©), mais la quantit√© que vous recevrez en √©tant auto-h√©berg√© peut √™tre aussi basse, voire plus basse, que celle que vous recevrez chez un Big Mailer Corp. Le spam n\u0026rsquo;est pas plus un souci en auto-h√©bergement qu\u0026rsquo;en Big Mailer Corp, peu importe √† quel point le marketing tente de vous convaincre du contraire.\nPour illustrer cela, j\u0026rsquo;ai vid√© ma boite √† Spam sur mon compte poolp.org et sur mon compte Big Mailer Corp ce matin, voici un screenshot des deux boites le soir m√™me, poolp.org √† gauche et Big Mailer Corp √† droite. Aucun des deux n\u0026rsquo;a de spam en Inbox.\nOK le SPAM n\u0026rsquo;est pas le souci mais mes mails n\u0026rsquo;atteindront pas les Big Mailer Corps # Un autre mythe, avec un peu plus de substance celui l√†, est qu\u0026rsquo;envoyer un e-mail depuis une adresse qui n\u0026rsquo;est pas un Big Mailer Corp va n√©cessairement se retrouver rejet√©e ou en spam.\nLaissez moi vous dire un secret: Les Big Mailer Corps ne sont pas inquiets de vos mails mais de ceux des gros √©metteurs qui harcellent leurs utilisateurs. Ils ne se soucient pas de serveurs personnels qui envoient quelques mails, m√™me si ce sont quelques milliers par mois. Ce qui est int√©resse ce sont les ordinateurs infect√©s ou les serveurs compromis qui floodent leurs utilisateurs. Ce qui les int√©resse ce sont les entreprises de marketing qui chient litt√©ralement sur eux, envoyant individuellement des millions de mails commerciaux par jour, en tentant d\u0026rsquo;√©viter les filtres anti-spam, et qui arrivent souvent √† contourner un petit moment avant de se faire rejeter. √Ä moins d\u0026rsquo;envoyer des centaines de milliers de mails vers eux tous les jours, honn√™tement et sans vouloir heurter vos sentiments, vous √™tes biiiiiiiiiiiiiiiiiiiiiiien en dessous des radars.\nAlors pourquoi j\u0026rsquo;ai dit que ce mythe avait plus de substance que les autres ?\nVolontairement ou non, les Big Mailer Corps ont introduit une preuve de travail dans les √©changes de mail.\nContrairement aux √©metteurs l√©gitimes qui tentent d\u0026rsquo;atteindre un utilisateur specifique, les spammers veulent atteindre une tonne d\u0026rsquo;utilisateurs quels qu\u0026rsquo;ils soient, parce que statistiquement certains vont tomber dans le panneau qui est dress√©. Parmi ces spammers, on va inclure les boites de marketing qui ach√®tent des listes d\u0026rsquo;utilisateurs de leurs partenaires et qui envoient de mani√®re indiscrimin√©e pour les \u0026ldquo;activer\u0026rdquo; dans l\u0026rsquo;espoir d\u0026rsquo;atteindre un pourcentage d\u0026rsquo;ouvertures.\nIls se fichent de savoir qui va recevoir le mail du moment qu\u0026rsquo;il est ouvert, parce que\u0026hellip; vous savez\u0026hellip; les statistiques tout √ßa. Donc plus c\u0026rsquo;est dur pour eux, plus il y a de chance qu\u0026rsquo;ils visent une autre cible pour pas perdre de temps et rester en avance sur leurs statistiques. Ne pensez pas que je fantasme √ßa, vous n\u0026rsquo;avez pas id√©e des astuces employ√©es pour faire m√©caniquement monter les ouvertures de quelques pourcents sur telle ou telle campagne.\n√Ä l\u0026rsquo;oppos√© de tout √ßa, vous avez les √©metteurs l√©gitimes qui visent des destinataires sp√©cifiques et ne peuvent pas simplement envoyer ailleurs. Des √©metteurs qui vont n√©cessairement devoir faire ce qu\u0026rsquo;il faut pour que √ßa marche, quitte √† bosser un peu plus.\nSachant cela, les Big Mailer Corps sont arriv√©s avec un jeu de r√®gles sur ce qu\u0026rsquo;un Bon √âmetteur devrait faire pour pouvoir communiquer avec eux. Ces listes de r√®gles sont concr√®tement une preuve de travail: elles ne garantissent pas que vous pourrez envoyer vers eux, elles ne garantissent pas que vous irez en inbox et pas en spam, mais elles sont l\u0026rsquo;ensemble minimal qu\u0026rsquo;il faut faire pour prouver que vous ne vous en foutez pas\u0026hellip; et comme certains spammers font de leur mieux pour paraitre sous un meilleur jour, si vous ne le faites pas vous m√™me √ßa veut concr√®tement dire que vous ne voulez m√™me pas faire mieux que les spammers.\nCes r√®gles ne sont pas l√† pour vous emb√™ter, elles sont m√™me tr√®s efficaces: certaines r√®gles ne peuvent pas √™tre respect√©es par un spammer qui aurait compromis une machine, par exemple, parce qu\u0026rsquo;il faudrait compromettre tout un domaine. Ce paradigme de la preuve de travail est ennuyant parce qu\u0026rsquo;il augmente (en temps) le co√ªt d\u0026rsquo;entr√©e, mais il permet aussi √† tous de b√©n√©ficier de ce travail pour tuer le spam. Puisque les Bons √âmetteurs veulent clairement passez chez les Big Mailer Corps, si vous recevez des connections de clients qui ne font pas le minimum pour pouvoir livrer du mail chez eux, vous pouvez probablement consid√©rer qu\u0026rsquo;ils peuvent √™tre p√©nalis√©s parce qu\u0026rsquo;ils sont d√©j√† p√©nalis√© sur la plus grosse portion de l\u0026rsquo;espace d\u0026rsquo;adressage.\nC\u0026rsquo;est pour cela que je dis que ce mythe a plus de substance que les autres. C\u0026rsquo;est vrai que SI l\u0026rsquo;ont ne fait pas le minimum de travail, ALORS on commence √† √™tre p√©nalis√©.\nEn pratique, une notion de r√©putation est aussi en jeu. Certaines personnes n\u0026rsquo;essaient m√™me pas mais sont tr√®s n dessous des radars\u0026hellip; et peuvent se permettre d\u0026rsquo;envoyer n\u0026rsquo;importe quoi sans souci. J\u0026rsquo;envoie souvent du mail vers mon compte Big Mailer Corp depuis un ordinateur portable de d√©veloppement, sur ma connexion domestique loin d\u0026rsquo;√™tres correctement configur√©e, et il arrive syst√©matiquement en inbox. Une bonne r√©putation permet de compenser des erreurs et de passer sans √™tre 100% irr√©prochable, alors qu\u0026rsquo;une mauvaise r√©putation augmente la quantit√© de travail √† fournir pour montrer patte blanche. En consid√©rant qu\u0026rsquo;une bonne r√©putation est acquise en faisant les bonnes choses, vous avez l\u0026rsquo;id√©e g√©n√©rale: faites les bonnes choses.\nLe set minimal de r√®gles √† respecter est TR√àS LOIN d\u0026rsquo;√™tre dur. Pour citer quelqu\u0026rsquo;un sur Twitter:\nJe n\u0026rsquo;ai jamais eu de probl√®me √† inboxer [\u0026hellip;]. Reverse DNS + SPF/DKIM et c\u0026rsquo;est bon. [\u0026hellip;]. Je crois que le plus dur √† g√©rer est le spam entrant.\nJe rajouterai bien deux ou trois choses √† sa liste mais √ßa montre bien que pour certaine personnes, c\u0026rsquo;est d√©j√† bon avec juste du rDNS, SPF et DKIM. La partie sur le spam entrant, on en a discut√© juste avant ;-)\nOK, alors pourquoi tout le monde dit que c\u0026rsquo;est dur ? # La premi√®re raison, c\u0026rsquo;est parce que personne ne dit le contraire et, comme Big Mailer Corps b√©n√©ficie de cette situation, ils ne vont pas la contredire non plus. Big Mailer Corps B√âN√âFICIE du mythe que le mail est dur parce que √ßa veut dire que davantage de personnes d√©pendent de leurs services, ils contr√¥lent une plus grosse portion de l\u0026rsquo;espace d\u0026rsquo;adressage, et √ßa se traduit par plus de mails qui peuvent √™tre analys√©s pour de la publicit√© cibl√©e et du rapport de force.\nPlus les gens sont d√©courag√©s, plus les gens vont √©ventuellement s\u0026rsquo;inscrire √† leurs services, et comme ils contr√¥le d√©j√† une grosse portion de l\u0026rsquo;adressage, ils peuvent rendre le mail encore un petit peu plus difficile en augmentant leurs pr√©-requis (plus difficile, PAS difficile). Ce n\u0026rsquo;est PAS quelque chose qu\u0026rsquo;ils font par conspiration, c\u0026rsquo;est juste la cons√©quence strat√©gique de leur donner plus de pouvoir parce que les gens s\u0026rsquo;√©loignent de l\u0026rsquo;auto-h√©bergement.\nUne autre raison est parce que √ßa a √©t√© dur il y a tr√®s longtemps. Des gens ont √©t√© traumatis√©s par le niveau de difficult√© pour ne pas rater et n\u0026rsquo;ont jamais r√©√©valu√©s la situation. De nombreuses personnes aujourd\u0026rsquo;hui d√©couragent d\u0026rsquo;autres de se lancer en citant des difficult√©s rencontr√©es il y a des d√©cennies alors que beaucoup d\u0026rsquo;outils √† disposition aujourd\u0026rsquo;hui n\u0026rsquo;existaient pas et que le paysage a bien chang√©.\nEt finallement, une autre raison est que des gens r√©p√®tent ce qu ils ont entendu sans jamais essayer eux-m√™mes. Je le sais parce que des gens m\u0026rsquo;ont dit que le mail est dur ces dix derni√®res ann√©es et que chaque fois que j\u0026rsquo;ai demand√© ce qu\u0026rsquo;ils trouvaient dur pour essayer de comprendre et am√©liorer la situation. La GRANDE majorit√© des gens ont confess√©s ne jamais avoir vraiment essay√©: ils ont lu ou enten du que c\u0026rsquo;√©tait dur, souvent depuis une source de confiance, ils ont accept√© cela comme un fait et commenc√©s √† r√©p√©ter √† leur tour que le mail est dur. On ne peut pas vraiment leur reprocher quand le mythe a √©t√© pr√©sent aussi longtemps, si je n\u0026rsquo;avais pas de connaissances pr√©alables et que je faisais une recherche rapide pour monter mon serveur de mail, je d√©ciderai probabelement que la complexit√© n\u0026rsquo;en vaut pas le b√©n√©fice vu ce qu\u0026rsquo;en disent les gens.\nAlors on fait quoi maintenant ? # On doit r√©cup√©rer le mail. Je ne veux pas dire que personne ne doit √™tre h√©berg√© par Big Mailer Corps, mais que √ßa ne devrait pas √™tre le r√©flexe Pavlovien √† la question \u0026ldquo;o√π est-ce que je peux ouvrir une boite mail ?\u0026rdquo;.\nTant qu\u0026rsquo;il y a assez de serveurs de mail dehors, Big Mailer Corps DOIT rester amical parce que leurs utilisateurs peuvent se plaindre que du mail l√©gitime est perdu ou bloqu√©, ce qui risque de faire fuire des utilisateurs ailleurs, moins d\u0026rsquo;e-mails, moins de ciblage, moins de $$$.\nSi le nombre de serveurs de mail se r√©duit au point que le trafic ne provenant pas d\u0026rsquo;un Big Mailer Corps est insignificant, alors cela devient leur protocole et ils peuvent inventer de nouvelles r√®gles qui ne sont plus soutenables par personne √† part eux.\nEncore une fois, ce n\u0026rsquo;est PAS une th√©orie du complot mais un effet secondaire d\u0026rsquo;√™tre une poign√©e aux manettes: pourquoi se plier √† des standards qui fonctionneraient pour tous et s\u0026rsquo;assurer une interop√©rabilit√©\u0026hellip; si la plupart du trafic est d√©j√† chez moi et que je peux customiser pour offrir des services qui v√©rouilleront les utilisateurs chez moi ?\nC\u0026rsquo;est d√©j√† en train de se produire avec l\u0026rsquo;un des Big Mailer Corp qui requiert que les e-mails soient envoy√©s depuis l\u0026rsquo;un de ses copains pour √™tre inbox√©\u0026hellip; ou alors que les √©metteurs fassent partie du carnet de contact (h√©berg√© chez lui bien s√ªr) pour less autres. Tout autre √©metteurs commencera par faire un petit s√©jour en spambox avant d\u0026rsquo;√©ventuellement passer en inbox.\nOn ne peut pas laisser cela se produire: autoriser les e-mails √† √™tre compl√®tement control√©s par une petite poign√©e d\u0026rsquo;entreprises priv√©es revient √† accepter qu\u0026rsquo;ils puissent imposer toutes les r√®gles de la communication par e-mail.\nIl est tr√®s important que l\u0026rsquo;on ne laisse pas le mythe se propagager plus. Notre int√©r√™t est d\u0026rsquo;avoir une GRANDE vari√©t√© de choix de fournisseurs d\u0026rsquo;e-mail, petits et grands, commerciaux ou non. Il faut augmenter le nombre de fournisseurs pour que le nombre d\u0026rsquo;adresse e-mail en dehors des Big Mailer Corps reste significatif.\nEt surtout, il ne faut pas pousser tout le monde syst√©matiquement √† utiliser Big Mailer Corps, en particulier parce que beaucoup de ces personnes lisent leurs e-mails depuis un smartphone et se fichent de l\u0026rsquo;interface, ils pourraient utiliser presque n\u0026rsquo;importe quel fournisseur et √™tre contents.\nJ\u0026rsquo;esp√®re que mon point sera entendu, partagez cela o√π vous voulez et avec qui vous voulez, redirigez vers cet article ou reproduisez le ailleurs.\nDans quelques jours, je publierai un guide pratique pour mettre en place un serveur similaire au mien, fournissant de la protection spam pour le mail entrant, et une preuve de travail suffisante pour rendre la plupart des Big Mailer Corps heureux.\n","date":"30 Janvier 2019","permalink":"/fr/posts/2019-08-30/vous-ne-devriez-pas-faire-tourner-votre-serveur-de-mail-parce-que-cest-dur/","section":"Posts","summary":"TL;DR: Le mail n\u0026rsquo;est pas dur: les gens r√©p√®tent √ßa parce qu\u0026rsquo;ils l\u0026rsquo;ont lu, pas parce qu\u0026rsquo;ils ont essay√© Les Big Mailer Corps sont content de ce mythe, √ßa fait grossir leur base d\u0026rsquo;utilisateurs Les Big Mailer Corps contr√¥lent un large pourcentage de l\u0026rsquo;espace d\u0026rsquo;adressage des e-mails ce qui n\u0026rsquo;est bon pour personne C\u0026rsquo;est ok que des gens aient leurs adresses e-mails h√©berg√©s chez des Big Mailer Corps tant qu\u0026rsquo;il y a assez de gens en dehors EDIT (2019-12-15) # Un guide practice pour installer un serveur de mail a √©t√© publi√© sur ce blog.","title":"Vous ne devriez pas faire tourner votre serveur de mail parce que c'est dur"},{"content":"Yop,\nLes services de poolp.org sont h√©berg√©s sur plusieurs serveurs.\nLe serveur principal √† √©t√© bascul√© d\u0026rsquo;un petit h√©bergeur US \u0026ldquo;OpenBSD-friendly\u0026rdquo; vers Online.net depuis 3 ans maintenant. J\u0026rsquo;ai rus√© √† l\u0026rsquo;√©poque pour installer OpenBSD sur la Dedibox \u0026ldquo;DC\u0026rdquo; en utilisant une vieille version de Yaifo et en faisant des upgrades successives du syst√®me d\u0026rsquo;exploitation. Mis √† part 3 petits downtimes dont 1 de ma responsabilit√©, je n\u0026rsquo;ai jamais eu √† me plaindre de leurs services et de leur mat√©riel.\nLe serveur secondaire, qui ne fournit que de l\u0026rsquo;espace disque pour les backups et un service de DNS et de SMTP secondaire en cas de panne du serveur primaire, est actuellement un serveur Kimsufi de chez OVH sur lequel j\u0026rsquo;ai install√© OpenBSD via le vKVM. Le serveur est sous-utilis√©, recevant un trafic anecdotique en dehors des backups journaliers en provenance du serveur primaire, mais je suis globalement content du service qui n\u0026rsquo;a pas subi de downtime depuis plus d\u0026rsquo;un an en ce qui me concerne.\nDes fois, pour les besoins d\u0026rsquo;un projet, je prends un serveur suppl√©mentaire pour une dur√©e ind√©termin√©e et je le laisse expirer √† la fin du projet, ou bien je bascule le serveur secondaire dessus si √† prix √©quivalent le mat√©riel est plus confortable.\nCe week-end, je me suis rendu compte de la disponibilit√© des nouveaux serveurs Dedibox Classic+ Gen2 qui avaient l\u0026rsquo;air pas mal sexy. J\u0026rsquo;allais justement renouveller un serveur un peu moins confortable au m√™me tarif, j\u0026rsquo;ai donc d√©cid√© de prendre un nouveau serveur chez Online et de laisser expirer celui que j\u0026rsquo;allais renouveller chez OVH.\nLe Classic+ Gen2 avait l\u0026rsquo;air assez sympa et la dispo d\u0026rsquo;un KVM/IP laissait pr√©sager qu\u0026rsquo;installer OpenBSD serait une partie de plaisir.\nCa, c\u0026rsquo;√©tait avant d\u0026rsquo;essayer pour de vrai.\nLet\u0026rsquo;s go !\nMon serveur est command√© et je recoit peu apr√®s un mail m\u0026rsquo;indiquant sa disponibilit√©. Ni une, ni deux, je me loggue et ne vois pas de menu pour avoir acc√®s au KVM, juste un bouton \u0026ldquo;Install\u0026rdquo;.\nComme il me faudra de toutes facons connaitre un peu le materiel avant d\u0026rsquo;installer OpenBSD par KVM, je prends le premier OS de la liste et lance une install pour pouvoir recuperer quelques infos du dmesg.\nL\u0026rsquo;install est rapide, il faut attendre un d√©lai d\u0026rsquo;une heure avant de r√©ussir √† se connecter √† la machine par SSH. Ca laisse le temps de chercher comment on acc√®de au KVM depuis la console Online.\niDRAC\nL\u0026rsquo;Install de Debian finie, des menus suppl√©mentaires apparaissent dans la console Online, dont le menu iDrac qui permets de lancer une console virtuelle.\nPas de bol, il faut un OS \u0026ldquo;java\u0026rdquo;-compliant, je viens de vendre mon laptop et je n\u0026rsquo;ai rien qui fasse l\u0026rsquo;affaire. Apr√®s moultes gal√®res, je mets la main sur un Windows et je lance la console virtuelle, choisis l\u0026rsquo;ISO d\u0026rsquo;OpenBSD et tente un boot.\nPendant le boot, perte de connexion, impossible de relancer la console virtuelle, impossible de rebooter le serveur depuis la console Online ou bien simplement de faire un ssh sur la machine (normal, elle est en plein boot de l\u0026rsquo;installeur OpenBSD\u0026hellip;).\nSur le canal IRC d\u0026rsquo;#online, on m\u0026rsquo;indique que l\u0026rsquo;iDRAC est dans le caniveau, une intervention est planifiee.\nJe retente de differentes facons, mais le crash de l\u0026rsquo;iDRAC est systematique et me fait perdre la main completement sur le serveur sans aucune action possible √† part qu√©mander un red√©marrage sur IRC et/ou ouvrir un ticket pour planifier une intervention.\nA la cinqui√®me tentative, mes reves d\u0026rsquo;install par KVM/IP s\u0026rsquo;envolent, on me sugg√®re de faire tourner une VM (ESXi est propos√© comme OS), mais je suis pas trop fan donc\u0026hellip;\nQEMU √† la rescousse\nJe cherche du cot√© de Yaifo vu qu\u0026rsquo;il m\u0026rsquo;a sauv√© la vie la premi√®re fois, mais il n\u0026rsquo;est plus maintenu depuis un bail. J\u0026rsquo;envisage de le mettre √† jour, mais pas trop envie de rester sur le probl√®me 40 ans et l\u0026rsquo;id√©e de me retapper des heures d\u0026rsquo;attentes entre chaque intervention sur mes tentatives de tests √©chou√© m\u0026rsquo;enchante pas des masses.\nSur IRC, Enjolras (#gcu) me fait savoir qu\u0026rsquo;il a install√© DragonFlyBSD sur un Kimsufi en se servant d\u0026rsquo;un FreeBSD en mode rescue et d\u0026rsquo;unionfs pour faire l\u0026rsquo;install sur le disque physique depuis un QEMU lanc√© en curses.\nId√©e s√©duisante, en rescue sur une Dedibox m√™me pas besoin d\u0026rsquo;unionfs\u0026hellip;\nCi-dessous, voici donc la m√©thode pour installer le plus simplement possible un OpenBSD sur une Dedibox. Elle devrait marcher pour n\u0026rsquo;importe quel OS qui supporte le mat√©riel avec un minimum de changements. Merci Enjolras !\nR√©cup√©rer les infos utiles\nIl faut tout d\u0026rsquo;abord booter sur le Linux install√© et r√©cup√©rer une copie du dmesg.\nLa raison est toute simple, QEMU va simuler le mat√©riel, l\u0026rsquo;installation verra un disque et une interface r√©seau diff√©rentes de ceux du serveur physique. Lorsque l\u0026rsquo;installation sera termin√©e, si on reboot sur le serveur physique sans avoir fait quelques modifications, le syst√®me cherchera une interface et un disque inexistants avec le r√©sultat attendu\u0026hellip; un ticket pour une intervention dans quelques heures ;-)\nLes infos qui nous int√©ressent sont √©ventuellement le DUID pour identifier le disque dans /etc/fstab et la description des interfaces r√©seau pour retrouver le nom du driver qui les prendra en charge et ainsi pouvoir cr√©er les fichiers de conf r√©seau.\nSur le Classic+, j\u0026rsquo;ai d√©cid√© de ne pas me servir du DUID vu que c\u0026rsquo;est sympa mais pas obligatoire et pas d\u0026rsquo;un int√©r√™t fou dans mon cas. En revanche, un petit grep eth a mis en √©vidence deux interfaces r√©seau \u0026ldquo;Broadcom BCM5716\u0026rdquo; et un petit coup de man bnx √† confirm√© que le driver bnx(4) les prends en charge sous OpenBSD. QEMU proposera une interface Realtek prise en charge par le driver re(4), donc ca n\u0026rsquo;ira pas.\nLe disque dur est mont√© sur /dev/sda, avec OpenBSD dans QEMU il sera visible en tant que /dev/wd0c, et avec OpenBSD sur le serveur physique il sera visible en tant que /dev/sd0c.\nDe plus, il va nous falloir les infos pour la configuration r√©seau:\nadresse IP broadcast netmask gateway On peut les r√©cup√©rer depuis l\u0026rsquo;interface Online ou depuis ifconfig et route, en ce qui me concerne:\nadresse : 88.191.185.XXX broadcast : 88.191.185.255 netmask : 255.255.255.0 gateway : 88.191.185.1 Il faudra aussi l\u0026rsquo;adresse d\u0026rsquo;un serveur de nom pour √©viter de passer 4 plombes sur le reverse lookup √† la premi√®re connexion ssh, personnellement j\u0026rsquo;ai utilis√© le 8.8.8.8 de Google pour mon premier boot puisque j\u0026rsquo;installe un serveur de nom local par la suite.\nLet\u0026rsquo;s Go Pour De Vrai!\nPremi√®re √©tape: installer QEMU ;-) % sudo apt-get update % sudo apt-get install qemu\nSeconde √©tape: t√©l√©charger l\u0026rsquo;ISO d\u0026rsquo;install % wget ftp://ftp.fr.openbsd.org/pub/OpenBSD/5.3/amd64/install53.iso\nTroisi√®me √©tape: lancer l\u0026rsquo;install. % sudo qemu-system-x86_64 -curses -boot -d -cdrom install53.iso -hda /dev/sda\nA ce stade, qemu boot sur l\u0026rsquo;installer et on fait face a une install tout a fait normale d\u0026rsquo;OpenBSD. Je le lance en mono-cpu, je prefere une install qui boot sur un kernel monoproc la premi√®re fois et faire une install du kernel MP apr√®s le premier boot, chacun est libre de faire comme il veut ;-)\nJe ne vais pas documenter l\u0026rsquo;installation, il y a moultes informations √† ce sujet, par contre je vais juste faire une petite remarque utile pour vous √©viter de perdre du temps inutilement:\nen mode \u0026ldquo;auto\u0026rdquo;, disklabel ne consommera pas tout le disque, il faut faire un d√©coupage custom\nIl vaut mieux s\u0026rsquo;en rendre compte pendant l\u0026rsquo;install que de se gal√©rer √† faire les resize apr√®s \u0026hellip; croyez moi.\nInstallation finie ?\nAvant de quitter le mode rescue et de booter sur le serveur physique, quelques petites modifications.\nOn configure\u0026hellip;\n\u0026hellip; la gateway:\necho 88.191.185.1 \u0026gt; /etc/mygate\n\u0026hellip; l\u0026rsquo;interface r√©seau:\necho inet 88.191.185.XXX 255.255.255.0 88.191.185.255 \u0026gt; /etc/hostname.bnx0\n\u0026hellip; le resolver:\ncat \u0026lt; /etc/resolv.conf nameserver 8.8.8.8 search file bind EOF\n\u0026hellip; le fstab (attention √† pas se rater):\nsed \u0026rsquo;s/wd0/sd0/g\u0026rsquo; \u0026lt; /etc/fstab \u0026gt; /tmp/fstab \u0026amp;\u0026amp; mv /tmp/fstab /etc/fstab\n\u0026hellip; et HOP on reboot\nreboot\nPremier reboot\u0026hellip;\nLe premier boot est long. Tres long. En fait pas si long que ca, mais l\u0026rsquo;anxiete de devoir refaire un ticket pour une intervention et attendre 4h pour refaire une tentative donne l\u0026rsquo;impression que des heures s\u0026rsquo;ecoulent avant la premiere reponse aux ping ;-)\nUne fois ce stade, on doit pouvoir se SSH sur la machine dans un OpenBSD avec un kernel monoproc. Si c\u0026rsquo;est bon, il ne reste plus qu\u0026rsquo;√† installer le kernel MP:\ncp /bsd /bsd.sp ftp ftp://ftp.fr.openbsd.org/pub/OpenBSD/5.3/amd64/bsd.mp cp bsd.mp /bsd sync reboot\nAu reboot on est sur un OpenBSD 5.3 GENERIC#MP \\o/\nOpenBSD 5.3 (GENERIC.MP) #62: Tue Mar 12 18:21:20 MDT 2013 deraadt@amd64.openbsd.org:/usr/src/sys/arch/amd64/compile/GENERIC.MP real mem = 8557342720 (8160MB) avail mem = 8307052544 (7922MB) mainbus0 at root bios0 at mainbus0: SMBIOS rev. 2.7 @ 0xe6da0 (57 entries) bios0: vendor Dell Inc. version \u0026ldquo;2.2.3\u0026rdquo; date 10/25/2012 bios0: Dell Inc. PowerEdge R210 II acpi0 at bios0: rev 2 acpi0: sleep states S0 S4 S5 acpi0: tables DSDT FACP SPMI DMAR ASF! HPET APIC MCFG BOOT SSDT ASPT SSDT SSDT SPCR HEST ERST BERT EINJ acpi0: wakeup devices P0P1(S4) GLAN(S0) EHC1(S4) EHC2(S4) XHC_(S4) PXSX(S4) RP01(S5) PXSX(S4) RP02(S5) PXSX(S4) RP03(S5) PXSX(S4) RP04(S5) PXSX(S4) RP05(S5) PXSX(S4) RP06(S5) PXSX(S4) RP07(S5) PXSX(S4) RP08(S5) PEG0(S5) PEGP(S5) PEG1(S5) PEG2(S5) PEG3(S5) acpitimer0 at acpi0: 3579545 Hz, 24 bits acpihpet0 at acpi0: 14318179 Hz acpimadt0 at acpi0 addr 0xfee00000: PC-AT compat cpu0 at mainbus0: apid 0 (boot processor) cpu0: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3093.38 MHz cpu0: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV, PAT,PSE36,CFLUSH,DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL, DTES64,MWAIT,DSCPL,VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1, SSE4.2,x2APIC,POPCNT,DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF, PERF,ITSC,FSGSBASE,SMEP,ERMS cpu0: 256KB 64b/line 8-way L2 cache cpu0: apic clock running at 99MHz cpu1 at mainbus0: apid 2 (application processor) cpu1: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu1: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu1: 256KB 64b/line 8-way L2 cache cpu2 at mainbus0: apid 4 (application processor) cpu2: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu2: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu2: 256KB 64b/line 8-way L2 cache cpu3 at mainbus0: apid 6 (application processor) cpu3: Intel(R) Xeon(R) CPU E3-1220 V2 @ 3.10GHz, 3092.98 MHz cpu3: FPU,VME,DE,PSE,TSC,MSR,PAE,MCE,CX8,APIC,SEP,MTRR,PGE,MCA,CMOV,PAT,PSE36,CFLUSH, DS,ACPI,MMX,FXSR,SSE,SSE2,SS,HTT,TM,PBE,SSE3,PCLMUL,DTES64,MWAIT,DS-CPL, VMX,SMX,EST,TM2,SSSE3,CX16,xTPR,PDCM,PCID,SSE4.1,SSE4.2,x2APIC,POPCNT, DEADLINE,AES,XSAVE,AVX,F16C,RDRAND,NXE,LONG,LAHF,PERF,ITSC,FSGSBASE,SMEP,ERMS cpu3: 256KB 64b/line 8-way L2 cache ioapic0 at mainbus0: apid 0 pa 0xfec00000, version 20, 24 pins acpimcfg0 at acpi0 addr 0xe0000000, bus 0-255 acpiprt0 at acpi0: bus 0 (PCI0) acpiprt1 at acpi0: bus 3 (P0P1) acpiprt2 at acpi0: bus 2 (RP01) acpiprt3 at acpi0: bus -1 (RP02) acpiprt4 at acpi0: bus -1 (RP03) acpiprt5 at acpi0: bus -1 (RP04) acpiprt6 at acpi0: bus -1 (RP05) acpiprt7 at acpi0: bus -1 (RP06) acpiprt8 at acpi0: bus -1 (RP07) acpiprt9 at acpi0: bus -1 (RP08) acpiprt10 at acpi0: bus 1 (PEG0) acpiprt11 at acpi0: bus -1 (PEG1) acpiprt12 at acpi0: bus -1 (PEG2) acpiprt13 at acpi0: bus -1 (PEG3) acpicpu0 at acpi0: C3, C2, C1, PSS acpicpu1 at acpi0: C3, C2, C1, PSS acpicpu2 at acpi0: C3, C2, C1, PSS acpicpu3 at acpi0: C3, C2, C1, PSS acpipwrres0 at acpi0: FN00 acpipwrres1 at acpi0: FN01 acpipwrres2 at acpi0: FN02 acpipwrres3 at acpi0: FN03 acpipwrres4 at acpi0: FN04 acpitz0 at acpi0: critical temperature is 106 degC ipmi at mainbus0 not configured cpu0: Enhanced SpeedStep 3093 MHz: speeds: 3101, 3100, 3000, 2900, 2800, 2700, 2600, 2500, 2300, 2200, 2100, 2000, 1900, 1800, 1700, 1600 MHz pci0 at mainbus0 bus 0 pchb0 at pci0 dev 0 function 0 vendor \u0026ldquo;Intel\u0026rdquo;, unknown product 0x0158 rev 0x09 ppb0 at pci0 dev 1 function 0 \u0026ldquo;Intel Xeon E3-1200v2 PCIE\u0026rdquo; rev 0x09: msi pci1 at ppb0 bus 1 mpii0 at pci1 dev 0 function 0 \u0026ldquo;Symbios Logic SAS2008\u0026rdquo; rev 0x03: msi mpii0: PERC H200A, firmware 7.15.8.0 IR, MPI 2.0 scsibus0 at mpii0: 42 targets sd0 at scsibus0 targ 1 lun 0: SCSI4 0/direct fixed naa.600508e0000000003cd970ac3a16d00c sd0: 953344MB, 512 bytes/sector, 1952448512 sectors ehci0 at pci0 dev 26 function 0 \u0026ldquo;Intel 6 Series USB\u0026rdquo; rev 0x04: apic 0 int 20 usb0 at ehci0: USB revision 2.0 uhub0 at usb0 \u0026ldquo;Intel EHCI root hub\u0026rdquo; rev 2.00/1.00 addr 1 ppb1 at pci0 dev 28 function 0 \u0026ldquo;Intel 6 Series PCIE\u0026rdquo; rev 0xb4: msi pci2 at ppb1 bus 2 bnx0 at pci2 dev 0 function 0 \u0026ldquo;Broadcom BCM5716\u0026rdquo; rev 0x20: apic 0 int 16 bnx1 at pci2 dev 0 function 1 \u0026ldquo;Broadcom BCM5716\u0026rdquo; rev 0x20: apic 0 int 17 ehci1 at pci0 dev 29 function 0 \u0026ldquo;Intel 6 Series USB\u0026rdquo; rev 0x04: apic 0 int 23 usb1 at ehci1: USB revision 2.0 uhub1 at usb1 \u0026ldquo;Intel EHCI root hub\u0026rdquo; rev 2.00/1.00 addr 1 ppb2 at pci0 dev 30 function 0 \u0026ldquo;Intel 82801BA Hub-to-PCI\u0026rdquo; rev 0xa4 pci3 at ppb2 bus 3 vga1 at pci3 dev 3 function 0 \u0026ldquo;Matrox MGA G200eW\u0026rdquo; rev 0x0a wsdisplay0 at vga1 mux 1: console (80x25, vt100 emulation) wsdisplay0: screen 1-5 added (80x25, vt100 emulation) pcib0 at pci0 dev 31 function 0 \u0026ldquo;Intel C202 LPC\u0026rdquo; rev 0x04 ahci0 at pci0 dev 31 function 2 \u0026ldquo;Intel 6 Series AHCI\u0026rdquo; rev 0x04: msi, AHCI 1.3 scsibus1 at ahci0: 32 targets ichiic0 at pci0 dev 31 function 3 \u0026ldquo;Intel 6 Series SMBus\u0026rdquo; rev 0x04: apic 0 int 19 iic0 at ichiic0 sdtemp0 at iic0 addr 0x19: mcp98243 spdmem0 at iic0 addr 0x51: 8GB DDR3 SDRAM ECC PC3-10600 with thermal sensor isa0 at pcib0 isadma0 at isa0 com0 at isa0 port 0x3f8/8 irq 4: ns16550a, 16 byte fifo com1 at isa0 port 0x2f8/8 irq 3: ns16550a, 16 byte fifo pckbc0 at isa0 port 0x60/5 kbc: cmd word write error pcppi0 at isa0 port 0x61 spkr0 at pcppi0 mtrr: Pentium Pro MTRR support uhub2 at uhub0 port 1 \u0026ldquo;Intel Rate Matching Hub\u0026rdquo; rev 2.00/0.00 addr 2 uhidev0 at uhub2 port 1 configuration 1 interface 0 \u0026ldquo;Avocent USB Composite Device-0\u0026rdquo; rev 1.10/0.00 addr 3 uhidev0: iclass 3/1 ukbd0 at uhidev0: 8 variable keys, 6 key codes wskbd0 at ukbd0 mux 1 wskbd0: connecting to wsdisplay0 uhidev1 at uhub2 port 1 configuration 1 interface 1 \u0026ldquo;Avocent USB Composite Device-0\u0026rdquo; rev 1.10/0.00 addr 3 uhidev1: iclass 3/1 ums0 at uhidev1: 3 buttons, Z dir wsmouse0 at ums0 mux 0 uhub3 at uhub1 port 1 \u0026ldquo;Intel Rate Matching Hub\u0026rdquo; rev 2.00/0.00 addr 2 uhub4 at uhub3 port 5 \u0026ldquo;Standard Microsystems product 0x2514\u0026rdquo; rev 2.00/0.00 addr 3 vscsi0 at root scsibus2 at vscsi0: 256 targets softraid0 at root scsibus3 at softraid0: 256 targets root on sd0a (f32d1747471a3037.a) swap on sd0b dump on sd0b bnx0: address d4:ae:52:c8:01:89 brgphy0 at bnx0 phy 1: BCM5709 10/100/1000baseT PHY, rev. 8 bnx1: address d4:ae:52:c8:01:8a brgphy1 at bnx1 phy 1: BCM5709 10/100/1000baseT PHY, rev. 8\n","date":"8 Janvier 2013","permalink":"/fr/posts/2013-05-08/installer-openbsd-sur-une-dedibox-classic-gen2/","section":"Posts","summary":"Yop,\nLes services de poolp.org sont h√©berg√©s sur plusieurs serveurs.\nLe serveur principal √† √©t√© bascul√© d\u0026rsquo;un petit h√©bergeur US \u0026ldquo;OpenBSD-friendly\u0026rdquo; vers Online.net depuis 3 ans maintenant.","title":"Installer OpenBSD sur une dedibox Classic+ Gen2"},{"content":"Je sais pas pourquoi, mais je suis epuise alors que j\u0026rsquo;ai dormi pres de 14h cette nuit. J\u0026rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu\u0026rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci. L\u0026rsquo;odeur des langoustes grilles me chatouille les narines et, alors que je sirote une pinte de Guinness(c) (la premire d\u0026rsquo;une longue serie ?), j\u0026rsquo;entends le doux murmure des vagues wuuuuuush \u0026hellip;. wuuuuuuush \u0026hellip; couvert par le cri des mouettes t\u0026rsquo;as un syscall a finiiiiir \u0026hellip; t\u0026rsquo;as un syscall a finiiiiiiiiir \u0026hellip;\nEn rouvrant les yeux, un peu triste et du, j\u0026rsquo;entrevois deux lignes \u0026hellip;\n$ cc -c -I/usr/src/sys -D_KERNEL sys_whore.c $ \u0026hellip; qui me ramene la dure realite\u0026hellip; j\u0026rsquo;ai un syscall a terminer.\nMeme dans mes songes, je passe vraiment des vacances de merde \u0026hellip;\n[Ajout] Bon alors voila, j\u0026rsquo;ai perdu plusieurs heures dessus donc je vais donner une astuce qui va peut-etre epargner de nombreuses heures de recherche a mes camarades tech4 qui codent leur syscall pour BSD.\nint sys_whore(struct proc *p, void *v, register_t *retval) { return (0); } Mais a quoi peut bien servir retval alors qu\u0026rsquo;on a un return() dans le code, et comment faire pour faire retourner autre chose qu\u0026rsquo;un entier a notre syscall ?\nApres m\u0026rsquo;etre cogne pres d\u0026rsquo;une dizaine de syscalls sans en voir un seul qui utilisait le retval, j\u0026rsquo;ai demande sur le channel #netbsd ou on m\u0026rsquo;a dit de la merde.\nUn peu plus tard sur #openbsd, on m\u0026rsquo;a conseill la lecture de /usr/src/sys/i386/i386/trap.c et la tout devient evident a la lecture de la fonction syscall().\nEn realite, que se passe-t\u0026rsquo;il lorsqu\u0026rsquo;un programme demande l\u0026rsquo;execution de notre syscall ?\nLes parametres sont places en ordre inverse dans la stack Le numro de syscall est place dans le registre EAX L\u0026rsquo;interruption 0x80 fait passer en mode kernel qui execute\u0026hellip; la fonction syscall() definie dans le trap.c Quand on regarde ce qu\u0026rsquo;elle fait, on comprends mieux. Quelques morceaux choisis:\nregister_t code, args[8], rval[2]; [...] rval[0] = 0; /* valeur de retour de l\u0026#39;appel systeme */ [...] /* appel; on stock le return */ orig_error = error = (*callp-\u0026gt;sy_call)(p, args, rval); [...] switch (error) { [...] default: /* return different de zero (et de cas particuliers) */ bad: if (p-\u0026gt;p_emul-\u0026gt;e_errno) error = p-\u0026gt;p_emul-\u0026gt;e_errno[error]; frame.tf_eax = error; frame.tf_eflags |= PSL_C; /* carry bit */ break; } Explications: Le premier element de rval est la valeur de retour de notre syscall, a ne pas confondre avec le return. En fait, le return dans le code de notre syscall sert uniquement a determiner s\u0026rsquo;il s\u0026rsquo;est bien deroule, il renvoie 0 en cas de succes quoi qu\u0026rsquo;il arrive, et une valeur d\u0026rsquo;errno dans le cas contraire. Mais alors \u0026hellip; c\u0026rsquo;est pour ca que retval n\u0026rsquo;est presque jamais utilise dans les syscalls !\nEn effet, si le syscall rate son return sera un code errno et la fonction wrapper n\u0026rsquo;aura pas besoin de verifier retval puisque la valeur qu\u0026rsquo;elle devra renvoyer sera -1 ou NULL, donc pas besoin d\u0026rsquo;y toucher. De meme, si syscall reussi, comme generalement il est sense renvoyer 0, il n\u0026rsquo;a pas besoin d\u0026rsquo;y toucher non plus puisque retval[0] est initialise a 0 avant le call. Le seul cas ou retval est modifie alors c\u0026rsquo;est quand le syscall renvoie une valeur differente de 0 en cas de success\u0026hellip; la lecture de getpid() et de ses soeurs le confirme\u0026hellip; YOUPI !\nCa vous rappelle rien ? Dans ktrace en tech3 on avait eu le meme probleme, lorsqu\u0026rsquo;un syscall ratait il renvoyait non pas -1 mais une valeur differente de 0 et il fallait ruser avec EAX pour determiner s\u0026rsquo;il s\u0026rsquo;agissait d\u0026rsquo;un ratage ou pas pour afficher nous meme -1 comme etant la valeur de retour.\nUn mystere qui m\u0026rsquo;a occupe une partie de la journe est resolu ;)\n[Ajout #2] Si vous vous demandiez pourquoi retval est un tableau de deux entiers, la reponse m\u0026rsquo;est apparue tout a l\u0026rsquo;heure, je sais pas, un clair de lucidite. Comme son nom l\u0026rsquo;indique, c\u0026rsquo;est un tableau de registre (register_t), et si le premier element correspond au registre EAX (bah oui puisque la valeur de retour est placee dans ce registre), le fait que syscall() associe le registre EDX au second element peut sembler un peu bizarre.\nEt bien nan, en fait c\u0026rsquo;est pour resoudre un cas bien particulier, celui de sys_fork() puisqu\u0026rsquo;il renvoie DEUX valeurs de retour en cas de succes. Le pere recupere la valeur de retour; le pid, dans EAX et le fils recupere la valeur de retour, 0, dans EDX. Magique non ?\n","date":"21 Janvier 2005","permalink":"/fr/posts/2005-05-21/fatigue-et-envie-de-vacances.../","section":"Posts","summary":"Je sais pas pourquoi, mais je suis epuise alors que j\u0026rsquo;ai dormi pres de 14h cette nuit. J\u0026rsquo;ai envie de faire une pause, de me prendre une annee de vacances au bord de la plage les doigts de pieds dans le sable fin blanc pendant qu\u0026rsquo;on me sert du sorbet a la noix de coco sur fond de Gojira alors que le soleil me rechauffe le visage mais juste un peu, pas trop, voila, comme ca, merci.","title":"fatigue et envie de vacances..."},{"content":" Identification # Ce site web est d√©tenu et g√©r√© par Gilles CHEHADE, enregistr√© en tant qu\u0026rsquo;auto-entrepreneur sous le num√©ro SIRET 515 053 908 00031, situ√© au 30 Boulevard de l\u0026rsquo;estuaire, 44200 Nantes, France.\nSi vous devez contacter Gilles CHEHADE, vous pouvez envoyer un e-mail √† : gilles@poolp.org.\nAssurance # Les activit√©s de Gilles CHEHADE sont couvertes par un contrat d\u0026rsquo;assurance avec AIG, sous le num√©ro de contrat RD01416644U.\nH√©bergement du Site Web # Ce site web est auto-g√©r√© par Gilles CHEHADE et est h√©berg√© par Vultr.com.\nLes serveurs physiques du site se trouvent dans les diff√©rents centres de donn√©es de Vultr.com. En cas de plainte concernant le site ou son contenu, Gilles CHEHADE peut √™tre contact√© via l\u0026rsquo;e-mail mentionn√© ci-dessus.\nPolitique de Conservation des Donn√©es # Nous respectons votre vie priv√©e. Notre site web n\u0026rsquo;utilise pas de cookies ou de traceurs. Nous ne collectons aucune donn√©e personnelle sur nos visiteurs, √† l\u0026rsquo;exception des adresses IP, des horodatages et des pages visit√©es. Ces informations sont collect√©es conform√©ment √† la loi fran√ßaise et sont utilis√©es uniquement √† des fins de s√©curit√© et d\u0026rsquo;analyse. Ces donn√©es ne sont pas partag√©es avec des tiers et ne sont pas utilis√©es √† d\u0026rsquo;autres fins.\nToute modification de cette politique de confidentialit√© sera publi√©e sur cette page. Veuillez revenir fr√©quemment pour voir les mises √† jour ou les modifications de notre politique de confidentialit√©.\nCette politique a √©t√© mise √† jour pour la derni√®re fois le 18 juillet 2023.\n","date":"1 janv.vier 0001","permalink":"/fr/legal/","section":"poolp.org","summary":"Identification # Ce site web est d√©tenu et g√©r√© par Gilles CHEHADE, enregistr√© en tant qu\u0026rsquo;auto-entrepreneur sous le num√©ro SIRET 515 053 908 00031, situ√© au 30 Boulevard de l\u0026rsquo;estuaire, 44200 Nantes, France.","title":"Mentions L√©gales"},{"content":"","date":"1 janv.vier 0001","permalink":"/fr/series/","section":"Series","summary":"","title":"Series"}]